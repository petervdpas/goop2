<!-- internal/ui/templates/self.html -->
{{define "page.self"}}
<div class="page page-self">
  {{if not .RendezvousOnly}}
  <div class="create-tabs">
    <a class="create-tab active" href="/self">My Settings</a>
    <a class="create-tab" href="/self/groups">Groups</a>
  </div>
  {{end}}

  {{if .RendezvousOnly}}
    <h1>Rendezvous Server</h1>
    <div class="banner ok" style="margin-bottom: 14px;">Running in rendezvous-only mode</div>
  {{else}}
    <h1>Me</h1>
  {{end}}

  <div class="card identity-card">
    <img id="avatar-preview" class="avatar avatar-lg identity-avatar"
         src="{{if .AvatarHash}}/api/avatar?v={{.AvatarHash}}{{else}}/api/avatar{{end}}"
         alt="Avatar">
    <div class="identity-info">
      <div class="identity-name">{{.SelfName}}</div>
      <div class="identity-meta muted small">
        {{if .Cfg.Profile.Email}}{{.Cfg.Profile.Email}}{{else}}no email set{{end}}{{if .SelfID}}
        &middot; <code>{{.SelfID}}</code>{{end}}
      </div>
      <div class="identity-actions">
        <button type="button" class="btn secondary" id="avatar-choose-btn">Change avatar</button>
        {{if .AvatarHash}}<button type="button" class="btn secondary" id="avatar-remove-btn">Remove</button>{{end}}
        <input type="file" id="avatar-file-input" class="avatar-file-input" accept="image/*">
      </div>
    </div>
    {{if .RendezvousOnly}}
      {{if .RendezvousURL}}
      <a class="btn identity-site-btn"
         href="/open?url={{.RendezvousURL | urlquery}}"
         rel="noopener">Open dashboard</a>
      {{end}}
    {{else}}
      <a class="btn identity-site-btn"
         href="/open?url={{printf "%s/p/%s/" .BaseURL .SelfID | urlquery}}"
         rel="noopener">Open my site</a>
    {{end}}
  </div>

  <h1 id="settings" style="margin-top: 18px;">Settings</h1>

  <p class="muted small">
    Config file: <code>{{.CfgPath}}</code><br>
    Site folder: <code>{{.Cfg.Paths.SiteRoot}}</code>
  </p>

  {{if .Saved}}
    <div class="banner ok">Saved.</div>
  {{end}}

  {{if .Error}}
    <div class="banner err">{{.Error}}</div>
  {{end}}

  <form class="form" method="post" action="/settings/save">
    <input type="hidden" name="csrf" value="{{.CSRF}}">

    <div class="field">
      <label>Label</label>
      <input name="profile_label"
             value="{{.Cfg.Profile.Label}}"
             placeholder="Peer-A">
    </div>

    <div class="field">
      <label>Email</label>
      <input name="profile_email"
             type="email"
             value="{{.Cfg.Profile.Email}}"
             placeholder="you@example.com">
      <div class="hint">
        Your email is shared with other peers as part of your identity.
      </div>
    </div>

    <div class="field">
      <label>Viewer HTTP addr</label>
      <input name="viewer_http_addr"
             value="{{.Cfg.Viewer.HTTPAddr}}"
             placeholder=":7777">
      <div class="hint">
        Empty disables the viewer (UI will not start with -ui).
      </div>
    </div>

    <div class="field">
      <label>Debug mode</label>
      <div style="display: flex; align-items: center; gap: 8px;">
        <label class="switch" title="Enable debug mode">
          <input type="checkbox"
                 name="viewer_debug"
                 {{if .Cfg.Viewer.Debug}}checked{{end}}>
          <span class="slider"></span>
        </label>
        <span class="muted small">Show console debug indicator (F12)</span>
      </div>
    </div>

    <div class="field" style="max-width: 200px;">
      <label>Theme</label>
      <select name="viewer_theme">
        <option value="dark" {{if eq .Cfg.Viewer.Theme "dark"}}selected{{end}}>Dark</option>
        <option value="light" {{if eq .Cfg.Viewer.Theme "light"}}selected{{end}}>Light</option>
      </select>
    </div>

    <div class="grid2">
      <div class="field">
        <label>P2P listen port</label>
        <input name="p2p_listen_port"
               value="{{.Cfg.P2P.ListenPort}}"
               placeholder="0">
        <div class="hint">0 = random</div>
      </div>

      <div class="field">
        <label>mDNS tag</label>
        <input name="p2p_mdns_tag"
               value="{{.Cfg.P2P.MdnsTag}}"
               placeholder="goop-mdns">
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label>Presence TTL seconds</label>
        <input name="presence_ttl_sec"
               value="{{.Cfg.Presence.TTLSec}}"
               placeholder="20">
      </div>

      <div class="field">
        <label>Presence heartbeat seconds</label>
        <input name="presence_heartbeat_sec"
               value="{{.Cfg.Presence.HeartbeatSec}}"
               placeholder="5">
      </div>
    </div>

    <div class="card" style="margin-top: 12px;">
      <h3>Rendezvous</h3>

      <div class="rv-local">
        <div class="rv-local-title">Local rendezvous server</div>

        <div class="rv-local-toggle">
          <span class="muted small">Off</span>
          <label class="switch" title="Enable local rendezvous server">
            <input id="rv_host"
                   type="checkbox"
                   name="presence_rendezvous_host"
                   {{if .Cfg.Presence.RendezvousHost}}checked{{end}}>
            <span class="slider"></span>
          </label>
          <span class="muted small">On</span>
        </div>

        <div class="rv-local-row">
          <div class="field rv-port-field">
            <label>Port</label>
            <input id="rv_port"
                   name="presence_rendezvous_port"
                   value="{{.Cfg.Presence.RendezvousPort}}"
                   placeholder="8787">
            <div class="hint">
              Local service runs at <code>127.0.0.1:PORT</code>
              (publish later via Caddy).
            </div>
          </div>

          <div class="rv-open">
            <a id="rv-open-link"
               class="btn secondary"
               href="/open?url={{printf "http://127.0.0.1:%d/" .Cfg.Presence.RendezvousPort | urlquery}}"
               rel="noopener">
              Open rendezvous
            </a>
          </div>
        </div>
      </div>

      <div class="field" style="margin-top: 12px;">
        <label>WAN rendezvous</label>
        <input name="presence_rendezvous_wan"
               value="{{.Cfg.Presence.RendezvousWAN}}"
               placeholder="https://rendezvous.example.org">
        <div class="hint">
          Optional. Join WAN presence mesh (LAN + WAN).
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 12px;">
      <h3>Lua Scripting</h3>
      <div style="display: flex; align-items: center; gap: 8px;">
        <span class="muted small">Off</span>
        <label class="switch" title="Enable Lua chat scripts">
          <input type="checkbox" name="lua_enabled"
                 {{if .Cfg.Lua.Enabled}}checked{{end}}>
          <span class="slider"></span>
        </label>
        <span class="muted small">On</span>
      </div>
      <div class="hint">
        When enabled, peers can run !commands defined in your <code>{{.Cfg.Lua.ScriptDir}}</code> folder.
        {{if .Cfg.Lua.Enabled}}<a href="/lua">Manage scripts</a>{{end}}
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="submit">Save</button>
    </div>
  </form>

  <p class="muted small">
    Note: Changing networking or viewer settings may require restarting this peer.
  </p>
</div>

<script>
(function() {
  var fileInput = document.getElementById('avatar-file-input');
  var chooseBtn = document.getElementById('avatar-choose-btn');
  var removeBtn = document.getElementById('avatar-remove-btn');
  var preview = document.getElementById('avatar-preview');

  if (chooseBtn) {
    chooseBtn.addEventListener('click', function() {
      fileInput.click();
    });
  }

  if (fileInput) {
    fileInput.addEventListener('change', function() {
      var file = fileInput.files[0];
      if (!file) return;

      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 256;
        var ctx = canvas.getContext('2d');

        // Center-crop to square, then draw at 256x256
        var size = Math.min(img.width, img.height);
        var sx = (img.width - size) / 2;
        var sy = (img.height - size) / 2;
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 256, 256);

        canvas.toBlob(function(blob) {
          if (!blob) return;
          if (blob.size > 256 * 1024) {
            alert('Resized image still too large. Try a smaller image.');
            return;
          }

          var fd = new FormData();
          fd.append('avatar', blob, 'avatar.png');

          fetch('/api/avatar/upload', { method: 'POST', body: fd })
            .then(function(r) {
              if (!r.ok) throw new Error('Upload failed');
              return r.json();
            })
            .then(function(data) {
              preview.src = '/api/avatar?v=' + data.hash;
              if (!removeBtn) {
                // Reload to show the remove button
                window.location.reload();
              }
            })
            .catch(function(err) {
              alert('Upload failed: ' + err.message);
            });
        }, 'image/png');
      };
      img.src = URL.createObjectURL(file);
    });
  }

  if (removeBtn) {
    removeBtn.addEventListener('click', function() {
      fetch('/api/avatar/delete', { method: 'POST' })
        .then(function(r) {
          if (!r.ok) throw new Error('Delete failed');
          window.location.reload();
        })
        .catch(function(err) {
          alert('Delete failed: ' + err.message);
        });
    });
  }
})();
</script>
{{end}}
