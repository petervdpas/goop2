<!-- internal/ui/templates/self.html -->
{{define "page.self"}}
<div class="page page-self">
  {{if not .RendezvousOnly}}
  <div class="create-tabs">
    <a class="create-tab active" href="/self">My Settings</a>
    <a class="create-tab" href="/self/groups">Groups</a>
  </div>
  {{end}}

  {{if .RendezvousOnly}}
    <h1>Rendezvous Server</h1>
    <div class="banner ok" style="margin-bottom: 14px;">Running in rendezvous-only mode</div>
  {{else}}
    <h1>Me</h1>
  {{end}}

  <div class="card identity-card">
    <img id="avatar-preview" class="avatar avatar-lg identity-avatar"
         src="{{if .AvatarHash}}/api/avatar?v={{.AvatarHash}}{{else}}/api/avatar{{end}}"
         alt="Avatar">
    <div class="identity-info">
      <div class="identity-name">{{.SelfName}}</div>
      <div class="identity-meta muted small">
        {{if .Cfg.Profile.Email}}{{.Cfg.Profile.Email}}{{else}}no email set{{end}}{{if .SelfID}}
        &middot; <code>{{.SelfID}}</code>{{end}}
      </div>
      <div class="identity-actions">
        <button type="button" class="btn secondary" id="avatar-choose-btn">Change avatar</button>
        {{if .AvatarHash}}<button type="button" class="btn secondary" id="avatar-remove-btn">Remove</button>{{end}}
        <input type="file" id="avatar-file-input" class="avatar-file-input" accept="image/*">
      </div>
    </div>
    {{if .RendezvousOnly}}
      {{if .RendezvousURL}}
      <a class="btn identity-site-btn"
         href="{{.RendezvousURL}}"
         onclick="return openExternal(this.href)"
         rel="noopener">Open dashboard</a>
      {{end}}
    {{else}}
      <a class="btn identity-site-btn"
         href="{{printf "%s/p/%s/" .BaseURL .SelfID}}"
         onclick="return openExternal(this.href)"
         rel="noopener">Open my site</a>
    {{end}}
  </div>

  <p class="muted small" style="margin-top: 18px;">
    Config file: <code>{{.CfgPath}}</code><br>
    Site folder: <code>{{.Cfg.Paths.SiteRoot}}</code>
  </p>

  {{if .Saved}}
    <div class="banner ok">Saved.</div>
  {{end}}

  {{if .Error}}
    <div class="banner err">{{.Error}}</div>
  {{end}}

  <div class="settings-page">
    <!-- ── Sidebar ── -->
    <div class="settings-sidebar panel">
      <div class="settings-sidebar-head">
        <span class="settings-sidebar-title">Settings</span>
      </div>
      <ul class="settings-nav">
        <li class="settings-nav-item active" data-section="profile">Profile</li>
        <li class="settings-nav-item" data-section="viewer">Viewer</li>
        <li class="settings-nav-item" data-section="network">Network</li>
        <li class="settings-nav-item" data-section="rendezvous">Rendezvous</li>
        <li class="settings-nav-item" data-section="server">Server</li>
        <li class="settings-nav-item rv-server-nav" data-section="admin" id="nav-admin"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Admin</li>
        <li class="settings-nav-item rv-server-nav" data-section="registration" id="nav-registration"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Registration</li>
        <li class="settings-nav-item rv-server-nav" data-section="smtp" id="nav-smtp"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">SMTP</li>
        {{if not .RendezvousOnly}}
        <li class="settings-nav-item" data-section="scripting">Scripting</li>
        <li class="settings-nav-item" data-section="data">Data</li>
        {{end}}
      </ul>
    </div>

    <!-- ── Main area ── -->
    <div class="settings-main panel">
      <form method="post" action="/settings/save">
        <input type="hidden" name="csrf" value="{{.CSRF}}">

        <!-- Profile -->
        <div class="settings-section active" data-section="profile">
          <h3 class="settings-section-title">Profile</h3>

          <div class="field">
            <label>Label</label>
            <input name="profile_label"
                   value="{{.Cfg.Profile.Label}}"
                   placeholder="Peer-A">
          </div>

          <div class="field">
            <label>Email</label>
            <input name="profile_email"
                   type="email"
                   value="{{.Cfg.Profile.Email}}"
                   placeholder="you@example.com">
            <div class="hint">
              Your email is shared with other peers as part of your identity.
            </div>
          </div>
        </div>

        <!-- Viewer -->
        <div class="settings-section" data-section="viewer">
          <h3 class="settings-section-title">Viewer</h3>

          <div class="field">
            <label>Viewer HTTP addr</label>
            <input name="viewer_http_addr"
                   value="{{.Cfg.Viewer.HTTPAddr}}"
                   placeholder=":7777">
            <div class="hint">
              Empty disables the viewer (UI will not start with -ui).
            </div>
          </div>

          <div class="field">
            <label>Debug mode</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="switch" title="Enable debug mode">
                <input type="checkbox"
                       name="viewer_debug"
                       {{if .Cfg.Viewer.Debug}}checked{{end}}>
                <span class="slider"></span>
              </label>
              <span class="muted small">Show console debug indicator (F12)</span>
            </div>
          </div>

          <div class="field" style="max-width: 200px;">
            <label>Theme</label>
            <div id="settings-theme-select" class="gsel" data-value="{{.Cfg.Viewer.Theme}}">
              <input type="hidden" name="viewer_theme" value="{{.Cfg.Viewer.Theme}}">
              <button type="button" class="gsel-trigger">
                <span class="gsel-text">{{if eq .Cfg.Viewer.Theme "light"}}Light{{else}}Dark{{end}}</span>
                <span class="gsel-arrow">&#9662;</span>
              </button>
              <div class="gsel-dropdown">
                <button type="button" class="gsel-option{{if eq .Cfg.Viewer.Theme "dark"}} selected{{end}}" data-value="dark">Dark</button>
                <button type="button" class="gsel-option{{if eq .Cfg.Viewer.Theme "light"}} selected{{end}}" data-value="light">Light</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Network -->
        <div class="settings-section" data-section="network">
          <h3 class="settings-section-title">Network</h3>

          <div class="grid2">
            <div class="field">
              <label>P2P listen port</label>
              <input name="p2p_listen_port"
                     value="{{.Cfg.P2P.ListenPort}}"
                     placeholder="0">
              <div class="hint">0 = random</div>
            </div>

            <div class="field">
              <label>mDNS tag</label>
              <input name="p2p_mdns_tag"
                     value="{{.Cfg.P2P.MdnsTag}}"
                     placeholder="goop-mdns">
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Presence TTL seconds</label>
              <input name="presence_ttl_sec"
                     value="{{.Cfg.Presence.TTLSec}}"
                     placeholder="20">
            </div>

            <div class="field">
              <label>Presence heartbeat seconds</label>
              <input name="presence_heartbeat_sec"
                     value="{{.Cfg.Presence.HeartbeatSec}}"
                     placeholder="5">
            </div>
          </div>
        </div>

        <!-- Rendezvous -->
        <div class="settings-section" data-section="rendezvous">
          <h3 class="settings-section-title">Rendezvous</h3>

          <div class="field">
            <label>WAN rendezvous</label>
            <input name="presence_rendezvous_wan"
                   value="{{.Cfg.Presence.RendezvousWAN}}"
                   placeholder="https://rendezvous.example.org">
            <div class="hint">
              Optional. Join WAN presence mesh (LAN + WAN).
            </div>
          </div>
        </div>

        <!-- Server Setup -->
        <div class="settings-section" data-section="server">
          <h3 class="settings-section-title">Server Setup</h3>

          <div class="rv-local rv-local--title-only">
            <div class="rv-local-title">Run as Rendezvous Server</div>

            <div class="rv-local-toggle">
              <span class="muted small">Off</span>
              <label class="switch" title="Run as a dedicated rendezvous server (disables P2P)">
                <input id="rv_host"
                       type="checkbox"
                       name="presence_rendezvous_server"
                       {{if .Cfg.Presence.RendezvousOnly}}checked{{end}}
                       onchange="var on=this.checked;document.getElementById('rv-server-opts').style.display=on?'':'none';document.querySelectorAll('.rv-server-section').forEach(el=>el.style.display=on?'':'none');document.querySelectorAll('.rv-server-nav').forEach(el=>el.style.display=on?'':'none')">
                <span class="slider"></span>
              </label>
              <span class="muted small">On</span>
            </div>
          </div>

          <div id="rv-server-opts" style="margin-top:10px;{{if not .Cfg.Presence.RendezvousOnly}} display:none{{end}}">
            <div class="rv-local rv-local-row">
              <div class="field rv-port-field">
                <label>Bind address</label>
                <input name="presence_rendezvous_bind"
                       value="{{.Cfg.Presence.RendezvousBind}}"
                       placeholder="127.0.0.1">
                <div class="hint">
                  <code>127.0.0.1</code> = localhost only,
                  <code>0.0.0.0</code> = accept LAN connections.
                </div>
              </div>

              <div class="field rv-port-field">
                <label>Port</label>
                <input id="rv_port"
                       name="presence_rendezvous_port"
                       value="{{.Cfg.Presence.RendezvousPort}}"
                       placeholder="8787">
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>External URL</label>
              <input name="presence_external_url"
                     value="{{.Cfg.Presence.ExternalURL}}"
                     placeholder="https://example.com">
              <div class="hint">
                Public URL for servers behind NAT or reverse proxy.
                Shown to users instead of auto-discovered LAN IPs.
              </div>
            </div>
          </div>
        </div>

        <!-- Admin (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="admin" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Admin</h3>

          <div class="field">
            <label>Admin password</label>
            <input name="presence_admin_password"
                   type="password"
                   value="{{.Cfg.Presence.AdminPassword}}"
                   placeholder="(empty = admin panel disabled)">
            <div class="hint">
              Password for the <code>/admin</code> monitoring panel (HTTP Basic Auth, user: <code>admin</code>).
              Leave empty to disable the admin panel.
            </div>
          </div>
        </div>

        <!-- Registration (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="registration" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Registration</h3>

          <div class="field">
            <label>Require email registration</label>
            <div style="display: flex; align-items: center; gap: 8px; margin-top:6px">
              <span class="muted small">Off</span>
              <label class="switch" title="Only verified emails can be discovered">
                <input type="checkbox" name="presence_registration_required"
                       {{if .Cfg.Presence.RegistrationRequired}}checked{{end}}>
                <span class="slider"></span>
              </label>
              <span class="muted small">On</span>
            </div>
            <div class="hint">
              When enabled, only peers with verified email addresses will be visible to others.
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Registration webhook</label>
            <input name="presence_registration_webhook"
                   value="{{.Cfg.Presence.RegistrationWebhook}}"
                   placeholder="https://your-api.com/webhook">
            <div class="hint">
              Optional. Called when an email is verified (for monetization).
            </div>
          </div>
        </div>

        <!-- SMTP (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="smtp" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">SMTP</h3>
          <p class="muted small" style="margin-bottom:14px">
            Configure SMTP to send verification emails. If not configured, verification links are logged to the console.
          </p>

          <div class="grid2">
            <div class="field">
              <label>SMTP host</label>
              <input name="presence_smtp_host"
                     value="{{.Cfg.Presence.SMTPHost}}"
                     placeholder="smtp.protonmail.ch">
            </div>
            <div class="field">
              <label>SMTP port</label>
              <input name="presence_smtp_port"
                     type="number"
                     value="{{if .Cfg.Presence.SMTPPort}}{{.Cfg.Presence.SMTPPort}}{{end}}"
                     placeholder="587">
              <div class="hint">587 (STARTTLS) or 465 (SSL)</div>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>SMTP username</label>
              <input name="presence_smtp_username"
                     value="{{.Cfg.Presence.SMTPUsername}}"
                     placeholder="admin@goop2.com">
            </div>
            <div class="field">
              <label>SMTP password</label>
              <input name="presence_smtp_password"
                     type="password"
                     value="{{.Cfg.Presence.SMTPPassword}}"
                     placeholder="SMTP token">
            </div>
          </div>

          <div class="field">
            <label>From address</label>
            <input name="presence_smtp_from"
                   value="{{.Cfg.Presence.SMTPFrom}}"
                   placeholder="(defaults to username)">
            <div class="hint">
              Optional. Defaults to SMTP username if empty.
            </div>
          </div>
        </div>

        <!-- Scripting (peer only) -->
        {{if not .RendezvousOnly}}
        <div class="settings-section" data-section="scripting">
          <h3 class="settings-section-title">Lua Scripting</h3>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="muted small">Off</span>
            <label class="switch" title="Enable Lua chat scripts">
              <input type="checkbox" name="lua_enabled"
                     {{if .Cfg.Lua.Enabled}}checked{{end}}>
              <span class="slider"></span>
            </label>
            <span class="muted small">On</span>
          </div>
          <div class="hint">
            When enabled, peers can run !commands defined in your <code>{{.Cfg.Lua.ScriptDir}}</code> folder.
            {{if .Cfg.Lua.Enabled}}<a href="/lua">Manage scripts</a>{{end}}
          </div>
        </div>
        {{end}}

        <!-- Save bar -->
        <div class="settings-save-bar" id="settings-save-bar">
          <button class="btn" type="submit">Save</button>
          <span class="muted small">Changing networking or viewer settings may require a restart.</span>
        </div>
      </form>

      <!-- Data (peer only, outside form) -->
      {{if not .RendezvousOnly}}
      <div class="settings-section" data-section="data">
        <h3 class="settings-section-title">Import / Export</h3>
        <p class="muted small">Export your site as a .zip archive (files, database, lua scripts) or import one to restore.</p>
        <div style="display:flex;gap:0.75rem;margin-top:0.5rem;flex-wrap:wrap;">
          <button type="button" class="btn secondary" id="export-btn">Export site (.zip)</button>
          <button type="button" class="btn secondary" id="import-btn">Import site (.zip)</button>
          <input type="file" id="import-file" accept=".zip" style="display:none">
        </div>
      </div>
      {{end}}
    </div>
  </div>
</div>

<script>
(function() {
  // ── Settings sidebar navigation ──
  var navItems = document.querySelectorAll('.settings-nav-item');
  var sections = document.querySelectorAll('.settings-section');
  var saveBar  = document.getElementById('settings-save-bar');

  navItems.forEach(function(item) {
    item.addEventListener('click', function() {
      var target = item.getAttribute('data-section');
      navItems.forEach(function(n) { n.classList.remove('active'); });
      item.classList.add('active');
      sections.forEach(function(s) {
        s.classList.toggle('active', s.getAttribute('data-section') === target);
      });
      if (saveBar) {
        saveBar.style.display = (target === 'data') ? 'none' : '';
      }
    });
  });

  // ── Avatar upload ──
  var fileInput = document.getElementById('avatar-file-input');
  var chooseBtn = document.getElementById('avatar-choose-btn');
  var removeBtn = document.getElementById('avatar-remove-btn');
  var preview = document.getElementById('avatar-preview');

  if (chooseBtn) {
    chooseBtn.addEventListener('click', function() {
      fileInput.click();
    });
  }

  if (fileInput) {
    fileInput.addEventListener('change', function() {
      var file = fileInput.files[0];
      if (!file) return;

      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 256;
        var ctx = canvas.getContext('2d');

        // Center-crop to square, then draw at 256x256
        var size = Math.min(img.width, img.height);
        var sx = (img.width - size) / 2;
        var sy = (img.height - size) / 2;
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 256, 256);

        canvas.toBlob(function(blob) {
          if (!blob) return;
          if (blob.size > 256 * 1024) {
            alert('Resized image still too large. Try a smaller image.');
            return;
          }

          var fd = new FormData();
          fd.append('avatar', blob, 'avatar.png');

          fetch('/api/avatar/upload', { method: 'POST', body: fd })
            .then(function(r) {
              if (!r.ok) throw new Error('Upload failed');
              return r.json();
            })
            .then(function(data) {
              preview.src = '/api/avatar?v=' + data.hash;
              if (!removeBtn) {
                // Reload to show the remove button
                window.location.reload();
              }
            })
            .catch(function(err) {
              alert('Upload failed: ' + err.message);
            });
        }, 'image/png');
      };
      img.src = URL.createObjectURL(file);
    });
  }

  if (removeBtn) {
    removeBtn.addEventListener('click', function() {
      fetch('/api/avatar/delete', { method: 'POST' })
        .then(function(r) {
          if (!r.ok) throw new Error('Delete failed');
          window.location.reload();
        })
        .catch(function(err) {
          alert('Delete failed: ' + err.message);
        });
    });
  }

  // ── Export site ──
  var exportBtn = document.getElementById('export-btn');
  if (exportBtn) {
    var bridgeURL = {{.BridgeURL}};

    exportBtn.addEventListener('click', function() {
      exportBtn.disabled = true;
      exportBtn.textContent = 'Exporting...';

      fetch('/api/site/export')
        .then(function(res) {
          if (!res.ok) return res.text().then(function(t) { throw new Error(t); });
          var cd = res.headers.get('Content-Disposition') || '';
          var match = cd.match(/filename="?([^"]+)"?/);
          var filename = match ? match[1] : 'goop-export.zip';
          return res.blob().then(function(blob) { return { blob: blob, filename: filename }; });
        })
        .then(function(result) {
          // Use native save dialog via bridge if available
          if (bridgeURL) {
            var fd = new FormData();
            fd.append('file', result.blob, result.filename);
            fd.append('filename', result.filename);
            return fetch(bridgeURL + '/export-save', { method: 'POST', body: fd })
              .then(function(res) {
                if (!res.ok) throw new Error('Save dialog failed');
                return res.json();
              })
              .then(function(data) {
                if (data.cancelled) return;
                if (window.Goop && window.Goop.ui) {
                  Goop.ui.toast({ title: 'Exported', message: 'Saved to ' + data.path, duration: 3000 });
                }
              });
          }
          // Fallback: browser download
          var url = URL.createObjectURL(result.blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = result.filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          if (window.Goop && window.Goop.ui) {
            Goop.ui.toast({ title: 'Exported', message: 'Site archive downloaded.', duration: 3000 });
          }
        })
        .catch(function(err) {
          var errMsg = err.message || 'Unknown error';
          if (window.Goop && window.Goop.ui) {
            Goop.ui.toast({ title: 'Export Error', message: errMsg, duration: 6000 });
          } else {
            alert('Failed to export: ' + errMsg);
          }
        })
        .finally(function() {
          exportBtn.disabled = false;
          exportBtn.textContent = 'Export site (.zip)';
        });
    });
  }

  // ── Import site ──
  var importBtn  = document.getElementById('import-btn');
  var importFile = document.getElementById('import-file');

  if (importBtn && importFile) {
    var csrf = {{.CSRF}};

    importBtn.addEventListener('click', function() {
      importFile.click();
    });

    importFile.addEventListener('change', function() {
      var file = importFile.files[0];
      if (!file) return;

      var msg = 'Import "' + file.name + '"?\n\nThis will DELETE all your current site files and database tables and replace them with the archive contents. This cannot be undone.';

      function doImport() {
        var fd = new FormData();
        fd.append('csrf', csrf);
        fd.append('file', file);

        fetch('/api/site/import', { method: 'POST', body: fd })
          .then(function(res) {
            if (!res.ok) return res.text().then(function(t) { throw new Error(t); });
            return res.json();
          })
          .then(function() {
            if (window.Goop && window.Goop.ui) {
              Goop.ui.toast({ title: 'Site Imported', message: 'Archive applied. Redirecting to editor...', duration: 3000 });
            }
            setTimeout(function() { window.location.href = '/edit'; }, 1500);
          })
          .catch(function(err) {
            var errMsg = err.message || 'Unknown error';
            if (window.Goop && window.Goop.ui) {
              Goop.ui.toast({ title: 'Import Error', message: errMsg, duration: 6000 });
            } else {
              alert('Failed to import: ' + errMsg);
            }
          })
          .finally(function() {
            importFile.value = '';
          });
      }

      if (window.Goop && window.Goop.ui && window.Goop.ui.confirm) {
        Goop.ui.confirm(msg, 'Import Site').then(function(ok) {
          if (ok) doImport();
          else importFile.value = '';
        });
      } else if (confirm(msg)) {
        doImport();
      } else {
        importFile.value = '';
      }
    });
  }
})();
</script>
{{end}}
