{{define "page.self"}}
<div class="page page-self">
  {{if not .RendezvousOnly}}
  <div class="create-tabs">
    <a class="create-tab active" href="/self">My Settings</a>
    <a class="create-tab" href="/self/groups">Groups</a>
  </div>
  {{end}}

  {{if .RendezvousOnly}}
    <h1>Rendezvous Server</h1>
    <div class="banner ok" style="margin-bottom: 14px;">Running in rendezvous-only mode</div>
  {{else}}
    <h1>Me</h1>
  {{end}}

  <div class="card identity-card">
    <img id="avatar-preview" class="avatar avatar-lg identity-avatar"
         src="{{if .AvatarHash}}/api/avatar?v={{.AvatarHash}}{{else}}/api/avatar{{end}}"
         alt="Avatar">
    <div class="identity-info">
      <div class="identity-name">{{.SelfName}}</div>
      <div class="identity-meta muted small">
        {{if .Cfg.Profile.Email}}{{.Cfg.Profile.Email}}{{else}}no email set{{end}}{{if .SelfID}}
        &middot; <code>{{.SelfID}}</code>{{end}}
      </div>
      <div class="identity-actions">
        <button type="button" class="btn secondary" id="avatar-choose-btn">Change avatar</button>
        {{if .AvatarHash}}<button type="button" class="btn secondary" id="avatar-remove-btn">Remove</button>{{end}}
        <input type="file" id="avatar-file-input" class="avatar-file-input" accept="image/*">
      </div>
    </div>
    {{if .RendezvousOnly}}
      {{if .RendezvousURL}}
      <a class="btn identity-site-btn"
         href="{{.RendezvousURL}}"
         onclick="return openExternal(this.href)"
         rel="noopener">Open dashboard</a>
      {{end}}
    {{else}}
      <a class="btn identity-site-btn"
         href="{{printf "%s/p/%s/" .BaseURL .SelfID}}"
         onclick="return openExternal(this.href)"
         rel="noopener">Open my site</a>
    {{end}}
  </div>

  <p class="muted small" style="margin-top: 18px;">
    Config file: <code>{{.CfgPath}}</code><br>
    Site folder: <code>{{.Cfg.Paths.SiteRoot}}</code>
  </p>

  {{if .Saved}}
    <div class="banner ok">Saved.</div>
  {{end}}

  {{if .Error}}
    <div class="banner err">{{.Error}}</div>
  {{end}}

  <div class="settings-page">
    <!-- ── Sidebar ── -->
    <div class="settings-sidebar panel">
      <div class="settings-sidebar-head">
        <span class="settings-sidebar-title">Settings</span>
      </div>
      <ul class="settings-nav">
        <li class="settings-nav-item active" data-section="viewer">Viewer</li>
        <li class="settings-nav-item" data-section="calls">Calls</li>
        <li class="settings-nav-item" data-section="network">Network</li>
        <li class="settings-nav-item" data-section="rendezvous">Rendezvous</li>
        <li class="settings-nav-item" data-section="server">Server</li>
        <li class="settings-nav-item rv-server-nav" data-section="relay" id="nav-relay"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Relay</li>
        <li class="settings-nav-item rv-server-nav" data-section="admin" id="nav-admin"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Admin</li>
        <li class="settings-nav-item rv-server-nav" data-section="services" id="nav-services"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Services</li>
        {{if not .RendezvousOnly}}
        <li class="settings-nav-item" data-section="scripting">Scripting</li>
        <li class="settings-nav-item" data-section="data">Data</li>
        {{end}}
      </ul>
    </div>

    <!-- ── Main area ── -->
    <div class="settings-main panel">
      <form method="post" action="/settings/save">
        <input type="hidden" name="csrf" value="{{.CSRF}}">

        <!-- Viewer -->
        <div class="settings-section active" data-section="viewer">
          <h3 class="settings-section-title">Viewer</h3>

          <div class="field">
            <label>Viewer HTTP addr</label>
            <input name="viewer_http_addr"
                   value="{{.Cfg.Viewer.HTTPAddr}}"
                   placeholder=":7777">
            <div class="hint">
              Empty disables the viewer (UI will not start with -ui).
            </div>
          </div>

          <div class="field">
            <label>Debug mode</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="switch" title="Enable debug mode">
                <input type="checkbox"
                       name="viewer_debug"
                       {{if .Cfg.Viewer.Debug}}checked{{end}}>
                <span class="slider"></span>
              </label>
              <span class="muted small">Show console debug indicator (F12)</span>
            </div>
          </div>

          <div class="field">
            <label>Hide unverified peers</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="switch" title="Hide unverified peers from the peer list">
                <input type="checkbox"
                       name="viewer_hide_unverified"
                       {{if .Cfg.Viewer.HideUnverified}}checked{{end}}>
                <span class="slider"></span>
              </label>
              <span class="muted small">Only show peers with verified email addresses</span>
            </div>
          </div>

        </div>

        <!-- Calls -->
        <div class="settings-section" data-section="calls">
          <h3 class="settings-section-title">Video / Audio Calls</h3>

          {{if eq .WhichOS "linux"}}
          <div class="banner warn small" style="margin-bottom: 10px;">
            Video/audio calls may not work on Linux due to WebKitGTK limitations. Consider enabling the option below.
          </div>
          {{end}}

          <div class="field">
            <label>Disable video/audio calls</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="switch" title="Disable video/audio calls">
                <input type="checkbox"
                       name="viewer_video_disabled"
                       {{if .Cfg.Viewer.VideoDisabled}}checked{{end}}>
                <span class="slider"></span>
              </label>
              <span class="muted small">Peers will see that calls are unavailable</span>
            </div>
            <div class="hint">
              Enable this if your platform doesn't support camera/microphone access.
            </div>
          </div>

        </div>

        <!-- Network -->
        <div class="settings-section" data-section="network">
          <h3 class="settings-section-title">Network</h3>

          <div class="grid2">
            <div class="field">
              <label>P2P listen port</label>
              <input name="p2p_listen_port"
                     value="{{.Cfg.P2P.ListenPort}}"
                     placeholder="0">
              <div class="hint">0 = random</div>
            </div>

            <div class="field">
              <label>mDNS tag</label>
              <input name="p2p_mdns_tag"
                     value="{{.Cfg.P2P.MdnsTag}}"
                     placeholder="goop-mdns">
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Presence TTL seconds</label>
              <input name="presence_ttl_sec"
                     value="{{.Cfg.Presence.TTLSec}}"
                     placeholder="20">
            </div>

            <div class="field">
              <label>Presence heartbeat seconds</label>
              <input name="presence_heartbeat_sec"
                     value="{{.Cfg.Presence.HeartbeatSec}}"
                     placeholder="5">
            </div>
          </div>
        </div>

        <!-- Rendezvous -->
        <div class="settings-section" data-section="rendezvous">
          <h3 class="settings-section-title">Rendezvous</h3>

          <div class="field">
            <label>WAN rendezvous</label>
            <input name="presence_rendezvous_wan"
                   value="{{.Cfg.Presence.RendezvousWAN}}"
                   placeholder="https://rendezvous.example.org">
            <div class="hint">
              Optional. Join WAN presence mesh (LAN + WAN).
            </div>
          </div>
        </div>

        <!-- Server Setup -->
        <div class="settings-section" data-section="server">
          <h3 class="settings-section-title">Server Setup</h3>

          <div class="rv-local rv-local--title-only">
            <div class="rv-local-title">Run as Rendezvous Server</div>

            <div class="rv-local-toggle">
              <span class="muted small">Off</span>
              <label class="switch" title="Run as a dedicated rendezvous server (disables P2P)">
                <input id="rv_host"
                       type="checkbox"
                       name="presence_rendezvous_server"
                       {{if .Cfg.Presence.RendezvousOnly}}checked{{end}}
                       onchange="var on=this.checked;document.getElementById('rv-server-opts').style.display=on?'':'none';document.querySelectorAll('.rv-server-section').forEach(el=>el.style.display=on?'':'none');document.querySelectorAll('.rv-server-nav').forEach(el=>el.style.display=on?'':'none')">
                <span class="slider"></span>
              </label>
              <span class="muted small">On</span>
            </div>
          </div>

          <div id="rv-server-opts" style="margin-top:10px;{{if not .Cfg.Presence.RendezvousOnly}} display:none{{end}}">
            <div class="grid2">
              <div class="field">
                <label>Bind address</label>
                <input name="presence_rendezvous_bind"
                       value="{{.Cfg.Presence.RendezvousBind}}"
                       placeholder="127.0.0.1">
                <div class="hint">
                  <code>127.0.0.1</code> = localhost only,
                  <code>0.0.0.0</code> = accept LAN connections.
                </div>
              </div>

              <div class="field">
                <label>Port</label>
                <input id="rv_port"
                       name="presence_rendezvous_port"
                       value="{{.Cfg.Presence.RendezvousPort}}"
                       placeholder="8787">
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>External URL</label>
              <input name="presence_external_url"
                     value="{{.Cfg.Presence.ExternalURL}}"
                     placeholder="https://example.com">
              <div class="hint">
                Public URL for servers behind NAT or reverse proxy.
                Shown to users instead of auto-discovered LAN IPs.
              </div>
            </div>

          </div>
        </div>

        <!-- Relay (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="relay" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Relay</h3>
          <p class="muted small" style="margin-bottom:14px">
            Circuit relay v2 enables NAT traversal via hole-punching.
            Peers behind NAT connect through this relay, then upgrade to a direct connection.
            Forward the relay TCP port on your router.
          </p>

          <div class="grid2">
            <div class="field">
              <label>Relay port</label>
              <input name="presence_relay_port"
                     type="number"
                     value="{{if .Cfg.Presence.RelayPort}}{{.Cfg.Presence.RelayPort}}{{end}}"
                     placeholder="0 = disabled">
              <div class="hint">
                TCP port for the relay. 0 = disabled. E.g. <code>4001</code>.
              </div>
            </div>

            <div class="field">
              <label>Relay key file</label>
              <input name="presence_relay_key_file"
                     value="{{.Cfg.Presence.RelayKeyFile}}"
                     placeholder="data/relay.key">
              <div class="hint">
                Persistent identity key for the relay host.
              </div>
            </div>
          </div>
        </div>

        <!-- Admin (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="admin" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Admin</h3>

          <div class="field">
            <label>Admin password</label>
            <input name="presence_admin_password"
                   type="password"
                   value="{{.Cfg.Presence.AdminPassword}}"
                   placeholder="(empty = admin panel disabled)">
            <div class="hint">
              Password for the <code>/admin</code> monitoring panel (HTTP Basic Auth, user: <code>admin</code>).
              Leave empty to disable the admin panel.
            </div>
          </div>
        </div>

        <!-- Services (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="services" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">External Services</h3>
          <p class="muted small" style="margin-bottom:14px">
            Connect to standalone microservices. Leave empty to use built-in defaults.
          </p>

          <div class="svc-tabs">
            <div class="svc-tab active" data-svc="registration">Registration</div>
            <div class="svc-tab" data-svc="credits">Credits</div>
            <div class="svc-tab" data-svc="email">Email</div>
          </div>

          <!-- Registration tab -->
          <div class="svc-tab-panel active" data-svc="registration">
            <div class="field">
              <label>Service URL <span id="svc-reg-status" class="svc-status"></span></label>
              <input id="svc-reg-url" name="presence_registration_url"
                     value="{{.Cfg.Presence.RegistrationURL}}"
                     placeholder="http://localhost:8801">
              <div class="hint">
                Handles email verification and peer registration.
                The registration service controls whether email verification is required
                (<code>registration_required</code> in its config.json).
              </div>
            </div>
            <div class="field" style="margin-top:10px">
              <label>Admin Token</label>
              <div class="token-field">
                <input id="svc-reg-token" name="presence_registration_admin_token"
                       value="{{.Cfg.Presence.RegistrationAdminToken}}"
                       placeholder="Bearer token for admin endpoints">
                <button type="button" class="btn token-btn" onclick="generateToken('svc-reg-token')" title="Generate random token">Generate</button>
                <button type="button" class="btn token-btn" onclick="copyToken('svc-reg-token')" title="Copy token to clipboard">Copy</button>
              </div>
              <div class="hint">
                Set the same token as <code>admin_token</code> in the registration service's config.json.
                Required for the admin dashboard to read registration data.
              </div>
            </div>
          </div>

          <!-- Credits tab -->
          <div class="svc-tab-panel" data-svc="credits">
            <div class="field">
              <label>Service URL <span id="svc-credits-status" class="svc-status"></span></label>
              <input id="svc-credits-url" name="presence_credits_url"
                     value="{{.Cfg.Presence.CreditsURL}}"
                     placeholder="http://localhost:8800">
              <div class="hint">
                Enables template pricing and credit purchases.
                Set <code>dummy_mode</code> in the credits service config.json for safe testing.
              </div>
            </div>
            <div class="field" style="margin-top:10px">
              <label>Admin Token</label>
              <div class="token-field">
                <input id="svc-credits-token" name="presence_credits_admin_token"
                       value="{{.Cfg.Presence.CreditsAdminToken}}"
                       placeholder="Bearer token for admin endpoints">
                <button type="button" class="btn token-btn" onclick="generateToken('svc-credits-token')" title="Generate random token">Generate</button>
                <button type="button" class="btn token-btn" onclick="copyToken('svc-credits-token')" title="Copy token to clipboard">Copy</button>
              </div>
              <div class="hint">
                Set the same token as <code>admin_token</code> in the credits service's config.json.
                Required for the admin dashboard to read account data.
              </div>
            </div>
          </div>

          <!-- Email tab -->
          <div class="svc-tab-panel" data-svc="email">
            <div class="field">
              <label>Service URL <span id="svc-email-status" class="svc-status"></span></label>
              <input id="svc-email-url" name="presence_email_url"
                     value="{{.Cfg.Presence.EmailURL}}"
                     placeholder="http://localhost:8802">
              <div class="hint">
                Centralizes SMTP sending and HTML email templates.
                Point the registration service's <code>email_url</code> to this service for verification emails.
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <button type="button" class="btn secondary" id="svc-check-btn" style="font-size:0.85em">Check services</button>
          </div>
        </div>

        <!-- Scripting (peer only) -->
        {{if not .RendezvousOnly}}
        <div class="settings-section" data-section="scripting">
          <h3 class="settings-section-title">Lua Scripting</h3>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="muted small">Off</span>
            <label class="switch" title="Enable Lua chat scripts">
              <input type="checkbox" name="lua_enabled"
                     {{if .Cfg.Lua.Enabled}}checked{{end}}>
              <span class="slider"></span>
            </label>
            <span class="muted small">On</span>
          </div>
          <div class="hint">
            When enabled, peers can run !commands defined in your <code>{{.Cfg.Lua.ScriptDir}}</code> folder.
            {{if .Cfg.Lua.Enabled}}<a href="/lua">Manage scripts</a>{{end}}
          </div>
        </div>
        {{end}}

        <!-- Save bar -->
        <div class="settings-save-bar" id="settings-save-bar">
          <button class="btn" type="submit">Save</button>
          <span class="muted small">Changing networking or viewer settings may require a restart.</span>
        </div>
      </form>

      <!-- Data (peer only, outside form) -->
      {{if not .RendezvousOnly}}
      <div class="settings-section" data-section="data">
        <h3 class="settings-section-title">Import / Export</h3>
        <p class="muted small">Export your site as a .zip archive (files, database, lua scripts) or import one to restore.</p>
        <div style="display:flex;gap:0.75rem;margin-top:0.5rem;flex-wrap:wrap;">
          <button type="button" class="btn secondary" id="export-btn">Export site (.zip)</button>
          <button type="button" class="btn secondary" id="import-btn">Import site (.zip)</button>
          <input type="file" id="import-file" accept=".zip" style="display:none">
        </div>
      </div>
      {{end}}
    </div>
  </div>
</div>

<script>
function generateToken(inputId) {
  var arr = new Uint8Array(32);
  crypto.getRandomValues(arr);
  var token = 'goop2__' + btoa(String.fromCharCode.apply(null, arr)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  document.getElementById(inputId).value = token;
}

function copyToken(inputId) {
  var el = document.getElementById(inputId);
  if (!el || !el.value) return;
  navigator.clipboard.writeText(el.value).then(function() {
    var btn = el.parentNode.querySelector('[onclick*="copyToken"]');
    if (btn) { var orig = btn.textContent; btn.textContent = 'Copied!'; setTimeout(function(){ btn.textContent = orig; }, 1500); }
  });
}

(function() {
  // ── Service sub-tabs ──
  document.querySelectorAll('.svc-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      var target = tab.getAttribute('data-svc');
      document.querySelectorAll('.svc-tab').forEach(function(t) { t.classList.toggle('active', t.getAttribute('data-svc') === target); });
      document.querySelectorAll('.svc-tab-panel').forEach(function(p) { p.classList.toggle('active', p.getAttribute('data-svc') === target); });
    });
  });

  // ── Service health checks ──
  var checkBtn = document.getElementById('svc-check-btn');
  function checkServices() {
    var regStatus = document.getElementById('svc-reg-status');
    var credStatus = document.getElementById('svc-credits-status');
    var emailStatus = document.getElementById('svc-email-status');
    if (regStatus) regStatus.textContent = '...';
    if (credStatus) credStatus.textContent = '...';
    if (emailStatus) emailStatus.textContent = '...';
    if (checkBtn) { checkBtn.disabled = true; checkBtn.textContent = 'Checking...'; }

    fetch('/api/services/health')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (regStatus) {
          if (!data.registration.url) {
            regStatus.textContent = '';
          } else if (data.registration.ok) {
            var label = 'running';
            if (data.registration.dummy_mode) {
              label += ' (dummy)';
            } else {
              label += ' (active)';
            }
            regStatus.textContent = label;
            regStatus.className = 'svc-status ' + (data.registration.dummy_mode ? 'svc-warn' : 'svc-ok');
          } else {
            regStatus.textContent = 'not reachable';
            regStatus.className = 'svc-status svc-err';
          }
        }
        if (credStatus) {
          if (!data.credits.url) {
            credStatus.textContent = '';
          } else if (!data.registration.url || !data.registration.ok) {
            credStatus.textContent = 'needs registration service';
            credStatus.className = 'svc-status svc-warn';
          } else if (data.credits.ok) {
            var label = 'running';
            if (data.credits.dummy_mode) {
              label += ' (dummy)';
            }
            credStatus.textContent = label;
            credStatus.className = 'svc-status ' + (data.credits.dummy_mode ? 'svc-warn' : 'svc-ok');
          } else {
            credStatus.textContent = 'not reachable';
            credStatus.className = 'svc-status svc-err';
          }
        }
        if (emailStatus) {
          if (!data.email.url) {
            emailStatus.textContent = '';
          } else if (data.email.ok) {
            var label = 'running';
            if (data.email.dummy_mode) {
              label += ' (dummy)';
            }
            emailStatus.textContent = label;
            emailStatus.className = 'svc-status ' + (data.email.dummy_mode ? 'svc-warn' : 'svc-ok');
          } else {
            emailStatus.textContent = 'not reachable';
            emailStatus.className = 'svc-status svc-err';
          }
        }
      })
      .catch(function() {
        if (regStatus) regStatus.textContent = '';
        if (credStatus) credStatus.textContent = '';
        if (emailStatus) emailStatus.textContent = '';
      })
      .finally(function() {
        if (checkBtn) { checkBtn.disabled = false; checkBtn.textContent = 'Check services'; }
      });
  }
  if (checkBtn) {
    checkBtn.addEventListener('click', checkServices);
    // Auto-check on load if URLs are configured
    if ((document.getElementById('svc-reg-url') && document.getElementById('svc-reg-url').value) ||
        (document.getElementById('svc-credits-url') && document.getElementById('svc-credits-url').value) ||
        (document.getElementById('svc-email-url') && document.getElementById('svc-email-url').value)) {
      checkServices();
    }
  }

  // ── Settings sidebar navigation ──
  var navItems = document.querySelectorAll('.settings-nav-item');
  var sections = document.querySelectorAll('.settings-section');
  var saveBar  = document.getElementById('settings-save-bar');

  navItems.forEach(function(item) {
    item.addEventListener('click', function() {
      var target = item.getAttribute('data-section');
      navItems.forEach(function(n) { n.classList.remove('active'); });
      item.classList.add('active');
      sections.forEach(function(s) {
        s.classList.toggle('active', s.getAttribute('data-section') === target);
      });
      if (saveBar) {
        saveBar.style.display = (target === 'data') ? 'none' : '';
      }
    });
  });

  // ── Avatar upload ──
  var fileInput = document.getElementById('avatar-file-input');
  var chooseBtn = document.getElementById('avatar-choose-btn');
  var removeBtn = document.getElementById('avatar-remove-btn');
  var preview = document.getElementById('avatar-preview');

  if (chooseBtn) {
    chooseBtn.addEventListener('click', function() {
      fileInput.click();
    });
  }

  if (fileInput) {
    fileInput.addEventListener('change', function() {
      var file = fileInput.files[0];
      if (!file) return;

      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 256;
        var ctx = canvas.getContext('2d');

        // Center-crop to square, then draw at 256x256
        var size = Math.min(img.width, img.height);
        var sx = (img.width - size) / 2;
        var sy = (img.height - size) / 2;
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 256, 256);

        canvas.toBlob(function(blob) {
          if (!blob) return;
          if (blob.size > 256 * 1024) {
            alert('Resized image still too large. Try a smaller image.');
            return;
          }

          var fd = new FormData();
          fd.append('avatar', blob, 'avatar.png');

          fetch('/api/avatar/upload', { method: 'POST', body: fd })
            .then(function(r) {
              if (!r.ok) throw new Error('Upload failed');
              return r.json();
            })
            .then(function(data) {
              preview.src = '/api/avatar?v=' + data.hash;
              if (!removeBtn) {
                // Reload to show the remove button
                window.location.reload();
              }
            })
            .catch(function(err) {
              alert('Upload failed: ' + err.message);
            });
        }, 'image/png');
      };
      img.src = URL.createObjectURL(file);
    });
  }

  if (removeBtn) {
    removeBtn.addEventListener('click', function() {
      fetch('/api/avatar/delete', { method: 'POST' })
        .then(function(r) {
          if (!r.ok) throw new Error('Delete failed');
          window.location.reload();
        })
        .catch(function(err) {
          alert('Delete failed: ' + err.message);
        });
    });
  }

  // ── Export site ──
  var exportBtn = document.getElementById('export-btn');
  if (exportBtn) {
    var bridgeURL = {{.BridgeURL}};

    exportBtn.addEventListener('click', function() {
      exportBtn.disabled = true;
      exportBtn.textContent = 'Exporting...';

      fetch('/api/site/export')
        .then(function(res) {
          if (!res.ok) return res.text().then(function(t) { throw new Error(t); });
          var cd = res.headers.get('Content-Disposition') || '';
          var match = cd.match(/filename="?([^"]+)"?/);
          var filename = match ? match[1] : 'goop-export.zip';
          return res.blob().then(function(blob) { return { blob: blob, filename: filename }; });
        })
        .then(function(result) {
          // Use native save dialog via bridge if available
          if (bridgeURL) {
            var fd = new FormData();
            fd.append('file', result.blob, result.filename);
            fd.append('filename', result.filename);
            return fetch(bridgeURL + '/export-save', { method: 'POST', body: fd })
              .then(function(res) {
                if (!res.ok) throw new Error('Save dialog failed');
                return res.json();
              })
              .then(function(data) {
                if (data.cancelled) return;
                if (window.Goop && window.Goop.ui) {
                  Goop.ui.toast({ title: 'Exported', message: 'Saved to ' + data.path, duration: 3000 });
                }
              });
          }
          // Fallback: browser download
          var url = URL.createObjectURL(result.blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = result.filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          if (window.Goop && window.Goop.ui) {
            Goop.ui.toast({ title: 'Exported', message: 'Site archive downloaded.', duration: 3000 });
          }
        })
        .catch(function(err) {
          var errMsg = err.message || 'Unknown error';
          if (window.Goop && window.Goop.ui) {
            Goop.ui.toast({ title: 'Export Error', message: errMsg, duration: 6000 });
          } else {
            alert('Failed to export: ' + errMsg);
          }
        })
        .finally(function() {
          exportBtn.disabled = false;
          exportBtn.textContent = 'Export site (.zip)';
        });
    });
  }

  // ── Import site ──
  var importBtn  = document.getElementById('import-btn');
  var importFile = document.getElementById('import-file');

  if (importBtn && importFile) {
    var csrf = {{.CSRF}};

    importBtn.addEventListener('click', function() {
      importFile.click();
    });

    importFile.addEventListener('change', function() {
      var file = importFile.files[0];
      if (!file) return;

      var msg = 'Import "' + file.name + '"?\n\nThis will DELETE all your current site files and database tables and replace them with the archive contents. This cannot be undone.';

      function doImport() {
        var fd = new FormData();
        fd.append('csrf', csrf);
        fd.append('file', file);

        fetch('/api/site/import', { method: 'POST', body: fd })
          .then(function(res) {
            if (!res.ok) return res.text().then(function(t) { throw new Error(t); });
            return res.json();
          })
          .then(function() {
            if (window.Goop && window.Goop.ui) {
              Goop.ui.toast({ title: 'Site Imported', message: 'Archive applied. Redirecting to editor...', duration: 3000 });
            }
            setTimeout(function() { window.location.href = '/edit'; }, 1500);
          })
          .catch(function(err) {
            var errMsg = err.message || 'Unknown error';
            if (window.Goop && window.Goop.ui) {
              Goop.ui.toast({ title: 'Import Error', message: errMsg, duration: 6000 });
            } else {
              alert('Failed to import: ' + errMsg);
            }
          })
          .finally(function() {
            importFile.value = '';
          });
      }

      if (window.Goop && window.Goop.ui && window.Goop.ui.confirm) {
        Goop.ui.confirm(msg, 'Import Site').then(function(ok) {
          if (ok) doImport();
          else importFile.value = '';
        });
      } else if (confirm(msg)) {
        doImport();
      } else {
        importFile.value = '';
      }
    });
  }
})();
</script>
{{end}}
