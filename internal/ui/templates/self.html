{{define "page.self"}}
<div class="page page-self" data-csrf="{{.CSRF}}" data-bridge-url="{{.BridgeURL}}">
  {{if not .RendezvousOnly}}
  <div class="create-tabs">
    <a class="create-tab active" href="/self">My Settings</a>
    <a class="create-tab" href="/self/groups">Groups</a>
  </div>
  {{end}}

  {{if .RendezvousOnly}}
    <h1>Rendezvous Server</h1>
    <div class="banner ok" style="margin-bottom: 14px;">Running in rendezvous-only mode</div>
  {{end}}

  <div class="card identity-card">
    <img id="avatar-preview" class="avatar avatar-lg identity-avatar"
         src="{{if .AvatarHash}}/api/avatar?v={{.AvatarHash}}{{else}}/api/avatar{{end}}"
         alt="Avatar">
    <div class="identity-info">
      <div class="identity-name">{{.SelfName}}</div>
      <div class="identity-meta muted small">
        {{if .Cfg.Profile.Email}}{{.Cfg.Profile.Email}}{{else}}no email set{{end}}{{if .SelfID}}
        &middot; <code class="copy-hint-inline" onclick="Goop.core.copyToClipboard('{{.SelfID}}', event.target.closest('code'))" title="Click to copy Peer ID" style="cursor:pointer">{{.SelfID}}</code>{{end}}
      </div>
      <div class="identity-actions">
        <button type="button" class="btn secondary" id="avatar-choose-btn">Change avatar</button>
        {{if .AvatarHash}}<button type="button" class="btn secondary" id="avatar-remove-btn">Remove</button>{{end}}
        {{if .SelfID}}<button type="button" class="btn secondary" id="copy-peer-id-btn" onclick="navigator.clipboard.writeText('{{.SelfID}}').then(function(){var b=document.getElementById('copy-peer-id-btn');b.textContent='Copied!';setTimeout(function(){b.textContent='Copy Peer ID'},1200)})">Copy Peer ID</button>{{end}}
        <input type="file" id="avatar-file-input" class="avatar-file-input" accept="image/*">
      </div>
    </div>
    <div class="identity-aside">
      {{if .RendezvousOnly}}
        {{if .RendezvousURL}}
        <a class="btn identity-site-btn"
           href="{{.RendezvousURL}}"
           onclick="return openExternal(this.href)"
           rel="noopener">Open dashboard</a>
        {{end}}
      {{else}}
        <a class="btn identity-site-btn"
           href="{{printf "%s/p/%s/" .BaseURL .SelfID}}"
           onclick="return openSite('{{.SelfID}}', '{{.Cfg.Profile.Label}}')"
           rel="noopener">Open my site</a>
      {{end}}
      <div class="identity-details">
        <div class="identity-details-row"><span class="identity-details-label">Config</span> <code>{{.CfgPath}}</code></div>
        <div class="identity-details-row"><span class="identity-details-label">Site</span> <code>{{.Cfg.Paths.SiteRoot}}</code></div>
        {{if .Cfg.Viewer.ActiveTemplate}}
        <div class="identity-details-row"><span class="identity-details-label">Template</span> <code>{{.Cfg.Viewer.ActiveTemplate}}</code></div>
        {{end}}
      </div>
    </div>
  </div>

  {{if .Saved}}
    <div class="banner ok">Saved.</div>
  {{end}}

  {{if .Error}}
    <div class="banner err">{{.Error}}</div>
  {{end}}

  <div class="settings-page">
    <!-- ── Sidebar ── -->
    <div class="settings-sidebar panel">
      <div class="settings-sidebar-head">
        <span class="settings-sidebar-title">Settings</span>
      </div>
      <ul class="settings-nav">
        <li class="settings-nav-item active" data-section="viewer">Viewer</li>
        <li class="settings-nav-item" data-section="splash">Splash</li>
        <li class="settings-nav-item" data-section="calls">Calls</li>
        <li class="settings-nav-item" data-section="network">Network</li>
        <li class="settings-nav-item" data-section="rendezvous">Rendezvous</li>
        <li class="settings-nav-item" data-section="server">Server</li>
        <li class="settings-nav-item rv-server-nav" data-section="relay" id="nav-relay"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Relay</li>
        <li class="settings-nav-item rv-server-nav" data-section="admin" id="nav-admin"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Admin</li>
        <li class="settings-nav-item rv-server-nav" data-section="local-templates" id="nav-local-templates"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Templates</li>
        <li class="settings-nav-item rv-server-nav" data-section="services" id="nav-services"
            style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">Services</li>
        {{if not .RendezvousOnly}}
        <li class="settings-nav-item" data-section="scripting">Scripting</li>
        <li class="settings-nav-item" data-section="data">Data</li>
        {{end}}
      </ul>
    </div>

    <!-- ── Main area ── -->
    <div class="settings-main panel">
      <form method="post" action="/settings/save">
        <input type="hidden" name="csrf" value="{{.CSRF}}">

        <!-- Viewer -->
        <div class="settings-section active" data-section="viewer">
          <h3 class="settings-section-title">Viewer</h3>

          <div class="grid2">
            <div class="field">
              <label>Viewer HTTP addr</label>
              <input name="viewer_http_addr"
                     value="{{.Cfg.Viewer.HTTPAddr}}"
                     placeholder=":7777">
              <div class="hint">
                Empty disables the viewer (UI will not start with -ui).
              </div>
            </div>

            <div class="field">
              <label>Debug mode</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label class="switch" title="Enable debug mode">
                  <input type="checkbox"
                         name="viewer_debug"
                         {{if .Cfg.Viewer.Debug}}checked{{end}}>
                  <span class="slider"></span>
                </label>
                <span class="muted small">Show console debug indicator (F12)</span>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Hide unverified peers</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label class="switch" title="Hide unverified peers from the peer list">
                  <input type="checkbox"
                         name="viewer_hide_unverified"
                         {{if .Cfg.Viewer.HideUnverified}}checked{{end}}>
                  <span class="slider"></span>
                </label>
                <span class="muted small">Only show verified peers</span>
              </div>
            </div>

            <div class="field">
              <label>Open sites in external browser</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label class="switch" title="Open peer sites in external browser instead of embedded tabs">
                  <input type="checkbox"
                         name="viewer_open_sites_external"
                         {{if .Cfg.Viewer.OpenSitesExternal}}checked{{end}}>
                  <span class="slider"></span>
                </label>
                <span class="muted small">Use system browser for sites</span>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Peer offline grace period</label>
              <input type="number" name="viewer_peer_offline_grace_min"
                     min="1" max="60"
                     value="{{if .Cfg.Viewer.PeerOfflineGraceMin}}{{.Cfg.Viewer.PeerOfflineGraceMin}}{{else}}15{{end}}">
              <div class="hint">
                Minutes to keep an offline non-favorite before pruning (1–60). Adds to the ~{{.Cfg.Presence.TTLSec}}s heartbeat timeout.
              </div>
            </div>
            <div class="field"></div>
          </div>

        </div>

        <!-- Splash -->
        <div class="settings-section" data-section="splash">
          <h3 class="settings-section-title">Splash</h3>
          <p class="muted small" style="margin-bottom:12px">Choose the splash image shown on the Peers page and in the launcher.</p>

          <div class="splash-picker">
            <label class="splash-picker-option{{if eq .Cfg.Viewer.Splash "goop2-splash.png"}} selected{{end}}">
              <input type="radio" name="viewer_splash" value="goop2-splash.png"
                     {{if eq .Cfg.Viewer.Splash "goop2-splash.png"}}checked{{end}}>
              <img src="/assets/images/goop2-splash.png" alt="Splash 1">
            </label>
            <label class="splash-picker-option{{if or (eq .Cfg.Viewer.Splash "goop2-splash2.png") (eq .Cfg.Viewer.Splash "")}} selected{{end}}">
              <input type="radio" name="viewer_splash" value="goop2-splash2.png"
                     {{if or (eq .Cfg.Viewer.Splash "goop2-splash2.png") (eq .Cfg.Viewer.Splash "")}}checked{{end}}>
              <img src="/assets/images/goop2-splash2.png" alt="Splash 2">
            </label>
            <label class="splash-picker-option{{if eq .Cfg.Viewer.Splash "goop2-splash3.png"}} selected{{end}}">
              <input type="radio" name="viewer_splash" value="goop2-splash3.png"
                     {{if eq .Cfg.Viewer.Splash "goop2-splash3.png"}}checked{{end}}>
              <img src="/assets/images/goop2-splash3.png" alt="Splash 3">
            </label>
          </div>
        </div>

        <!-- Calls -->
        <div class="settings-section" data-section="calls">
          <h3 class="settings-section-title">Video / Audio Calls</h3>

          {{if eq .WhichOS "linux"}}
          <div class="banner warn small" style="margin-bottom: 10px;">
            Video/audio calls may not work on Linux due to WebKitGTK limitations. Consider enabling the option below.
          </div>
          {{end}}

          <div class="field">
            <label>Disable video/audio calls</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="switch" title="Disable video/audio calls">
                <input type="checkbox"
                       name="viewer_video_disabled"
                       {{if .Cfg.Viewer.VideoDisabled}}checked{{end}}>
                <span class="slider"></span>
              </label>
              <span class="muted small">Peers will see that calls are unavailable</span>
            </div>
            <div class="hint">
              Enable this if your platform doesn't support camera/microphone access.
            </div>
          </div>

        </div>

        <!-- Network -->
        <div class="settings-section" data-section="network">
          <h3 class="settings-section-title">Network</h3>

          <div class="grid2">
            <div class="field">
              <label>P2P listen port</label>
              <input name="p2p_listen_port"
                     value="{{.Cfg.P2P.ListenPort}}"
                     placeholder="0">
              <div class="hint">0 = random</div>
            </div>

            <div class="field">
              <label>mDNS tag</label>
              <input name="p2p_mdns_tag"
                     value="{{.Cfg.P2P.MdnsTag}}"
                     placeholder="goop-mdns">
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Presence TTL seconds</label>
              <input name="presence_ttl_sec"
                     value="{{.Cfg.Presence.TTLSec}}"
                     placeholder="20">
            </div>

            <div class="field">
              <label>Presence heartbeat seconds</label>
              <input name="presence_heartbeat_sec"
                     value="{{.Cfg.Presence.HeartbeatSec}}"
                     placeholder="5">
            </div>
          </div>
        </div>

        <!-- Rendezvous -->
        <div class="settings-section" data-section="rendezvous">
          <h3 class="settings-section-title">Rendezvous</h3>

          <div class="field">
            <label>WAN rendezvous</label>
            <input name="presence_rendezvous_wan"
                   value="{{.Cfg.Presence.RendezvousWAN}}"
                   placeholder="https://rendezvous.example.org">
            <div class="hint">
              Optional. Join WAN presence mesh (LAN + WAN).
            </div>
          </div>
        </div>

        <!-- Server Setup -->
        <div class="settings-section" data-section="server">
          <h3 class="settings-section-title">Server Setup</h3>

          <div class="rv-local rv-local--title-only">
            <div class="rv-local-title">Run as Rendezvous Server</div>

            <div class="rv-local-toggle">
              <span class="muted small">Off</span>
              <label class="switch" title="Run as a dedicated rendezvous server (disables P2P)">
                <input id="rv_host"
                       type="checkbox"
                       name="presence_rendezvous_server"
                       {{if .Cfg.Presence.RendezvousOnly}}checked{{end}}
                       onchange="var on=this.checked;document.getElementById('rv-server-opts').style.display=on?'':'none';document.querySelectorAll('.rv-server-section').forEach(el=>el.style.display=on?'':'none');document.querySelectorAll('.rv-server-nav').forEach(el=>el.style.display=on?'':'none')">
                <span class="slider"></span>
              </label>
              <span class="muted small">On</span>
            </div>
          </div>

          <div id="rv-server-opts" style="margin-top:10px;{{if not .Cfg.Presence.RendezvousOnly}} display:none{{end}}">
            <div class="grid2">
              <div class="field">
                <label>Bind address</label>
                <input name="presence_rendezvous_bind"
                       value="{{.Cfg.Presence.RendezvousBind}}"
                       placeholder="127.0.0.1">
                <div class="hint">
                  <code>127.0.0.1</code> = localhost only,
                  <code>0.0.0.0</code> = accept LAN connections.
                </div>
              </div>

              <div class="field">
                <label>Port</label>
                <input id="rv_port"
                       name="presence_rendezvous_port"
                       value="{{.Cfg.Presence.RendezvousPort}}"
                       placeholder="8787">
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>External URL</label>
              <input name="presence_external_url"
                     value="{{.Cfg.Presence.ExternalURL}}"
                     placeholder="https://example.com">
              <div class="hint">
                Public URL for servers behind NAT or reverse proxy.
                Shown to users instead of auto-discovered LAN IPs.
              </div>
            </div>

          </div>
        </div>

        <!-- Relay (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="relay" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Relay</h3>
          <p class="muted small" style="margin-bottom:14px">
            Circuit relay v2 enables NAT traversal via hole-punching.
            Peers behind NAT connect through this relay, then upgrade to a direct connection.
            Forward the relay TCP port on your router.
          </p>

          <div class="grid2">
            <div class="field">
              <label>Relay port</label>
              <input name="presence_relay_port"
                     type="number"
                     value="{{if .Cfg.Presence.RelayPort}}{{.Cfg.Presence.RelayPort}}{{end}}"
                     placeholder="0 = disabled">
              <div class="hint">
                TCP port for the relay. 0 = disabled. E.g. <code>4001</code>.
              </div>
            </div>

            <div class="field">
              <label>Relay key file</label>
              <input name="presence_relay_key_file"
                     value="{{.Cfg.Presence.RelayKeyFile}}"
                     placeholder="data/relay.key">
              <div class="hint">
                Persistent identity key for the relay host.
              </div>
            </div>
          </div>

          <p class="muted small" style="margin:14px 0 10px">
            Timing values pushed to clients via <code>/relay</code>.
            0 = use hardcoded default.
          </p>

          <div class="grid2">
            <div class="field">
              <label>Cleanup delay (sec)</label>
              <input name="presence_relay_cleanup_delay_sec"
                     type="number" min="0"
                     value="{{.Cfg.Presence.RelayCleanupDelaySec}}"
                     placeholder="3">
              <div class="hint">Wait before reconnecting after closing old relay connection. Default <code>3</code>.</div>
            </div>
            <div class="field">
              <label>Poll deadline (sec)</label>
              <input name="presence_relay_poll_deadline_sec"
                     type="number" min="0"
                     value="{{.Cfg.Presence.RelayPollDeadlineSec}}"
                     placeholder="25">
              <div class="hint">Max time to wait for reservation after reconnect. Default <code>25</code>.</div>
            </div>
          </div>
          <div class="grid2">
            <div class="field">
              <label>Connect timeout (sec)</label>
              <input name="presence_relay_connect_timeout_sec"
                     type="number" min="0"
                     value="{{.Cfg.Presence.RelayConnectTimeoutSec}}"
                     placeholder="15">
              <div class="hint">Dial timeout when connecting to relay peer. Default <code>15</code>.</div>
            </div>
            <div class="field">
              <label>Refresh interval (sec)</label>
              <input name="presence_relay_refresh_interval_sec"
                     type="number" min="0"
                     value="{{.Cfg.Presence.RelayRefreshIntervalSec}}"
                     placeholder="300">
              <div class="hint">Periodic check interval for missing circuit address. Default <code>300</code> (5 min).</div>
            </div>
          </div>
          <div class="grid2">
            <div class="field">
              <label>Recovery grace (sec)</label>
              <input name="presence_relay_recovery_grace_sec"
                     type="number" min="0"
                     value="{{.Cfg.Presence.RelayRecoveryGraceSec}}"
                     placeholder="5">
              <div class="hint">Grace period for AutoRelay self-recovery before manual recovery kicks in. Default <code>5</code>.</div>
            </div>
            <div class="field"></div>
          </div>
        </div>

        <!-- Admin (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="admin" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Admin</h3>

          <div class="field">
            <label>Admin password</label>
            <input name="presence_admin_password"
                   type="password"
                   value="{{.Cfg.Presence.AdminPassword}}"
                   placeholder="(empty = admin panel disabled)">
            <div class="hint">
              Password for the <code>/admin</code> monitoring panel (HTTP Basic Auth, user: <code>admin</code>).
              Leave empty to disable the admin panel.
            </div>
          </div>
        </div>

        <!-- Local Templates (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="local-templates" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <h3 class="settings-section-title">Local Templates</h3>
          <p class="muted small" style="margin-bottom:14px">
            Serve a template store directly from a folder on disk — no microservices needed.
            Peers can browse and apply these templates for free.
          </p>

          <div class="field">
            <label>Templates directory</label>
            <div class="token-field">
              <input id="templates-dir-input" name="presence_templates_dir"
                     value="{{.Cfg.Presence.TemplatesDir}}"
                     placeholder="templates">
              <button type="button" class="btn token-btn" id="templates-dir-browse">Browse</button>
            </div>
            <div class="hint">
              Path relative to the peer directory. Each subdirectory needs a <code>manifest.json</code>.
              Ignored when the Templates service URL is set in External Services.
            </div>
          </div>
        </div>

        <!-- Services (visible when server is enabled) -->
        <div class="settings-section rv-server-section" data-section="services" style="{{if not .Cfg.Presence.RendezvousOnly}}display:none{{end}}">
          <div class="rv-local rv-local--title-only">
            <div class="rv-local-title">External Services</div>
            <div class="rv-local-toggle">
              <span class="muted small">Off</span>
              <label class="switch" title="Enable external microservices (credits, registration, email, templates)">
                <input id="use_services"
                       type="checkbox"
                       name="presence_use_services"
                       {{if .Cfg.Presence.UseServices}}checked{{end}}
                       onchange="var on=this.checked;document.getElementById('svc-body').style.opacity=on?'1':'0.4';document.getElementById('svc-body').style.pointerEvents=on?'':'none';fetch('/api/settings/quick',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({use_services:on})})">
                <span class="slider"></span>
              </label>
              <span class="muted small">On</span>
            </div>
          </div>
          <p class="muted small" style="margin-bottom:14px">
            Connect to standalone microservices. Leave empty to use built-in defaults.
          </p>

          <div id="svc-body" style="{{if not .Cfg.Presence.UseServices}}opacity:0.4;pointer-events:none{{end}}">
          <div class="svc-tabs">
            <div class="svc-tab active" data-svc="registration">Registration</div>
            <div class="svc-tab" data-svc="credits">Credits</div>
            <div class="svc-tab" data-svc="email">Email</div>
            <div class="svc-tab" data-svc="templates">Templates</div>
          </div>

          <!-- Registration tab -->
          <div class="svc-tab-panel active" data-svc="registration">
            <div class="field">
              <label>Service URL <span id="svc-reg-status" class="svc-status"></span></label>
              <div class="token-field">
                <input id="svc-reg-url" name="presence_registration_url"
                       value="{{.Cfg.Presence.RegistrationURL}}"
                       placeholder="http://localhost:8801">
                <button type="button" class="btn token-btn svc-check-btn" data-svc-check="registration" style="display:none">Check</button>
              </div>
              <div class="hint">
                Handles email verification and peer registration.
                The registration service controls whether email verification is required
                (<code>registration_required</code> in its config.json).
              </div>
            </div>
            <div class="field" style="margin-top:10px">
              <label>Admin Token</label>
              <div class="token-field">
                <input id="svc-reg-token" name="presence_registration_admin_token"
                       value="{{.Cfg.Presence.RegistrationAdminToken}}"
                       placeholder="Bearer token for admin endpoints">
                <button type="button" class="btn token-btn" onclick="generateToken('svc-reg-token')" title="Generate random token">Generate</button>
                <button type="button" class="btn token-btn" onclick="copyToken('svc-reg-token')" title="Copy token to clipboard">Copy</button>
              </div>
              <div class="hint">
                Set the same token as <code>admin_token</code> in the registration service's config.json.
                Required for the admin dashboard to read registration data.
              </div>
            </div>
          </div>

          <!-- Credits tab -->
          <div class="svc-tab-panel" data-svc="credits">
            <div class="field">
              <label>Service URL <span id="svc-credits-status" class="svc-status"></span></label>
              <div class="token-field">
                <input id="svc-credits-url" name="presence_credits_url"
                       value="{{.Cfg.Presence.CreditsURL}}"
                       placeholder="http://localhost:8800">
                <button type="button" class="btn token-btn svc-check-btn" data-svc-check="credits" style="display:none">Check</button>
              </div>
              <div class="hint">
                Enables template pricing and credit purchases.
                Set <code>dummy_mode</code> in the credits service config.json for safe testing.
              </div>
            </div>
            <div class="field" style="margin-top:10px">
              <label>Admin Token</label>
              <div class="token-field">
                <input id="svc-credits-token" name="presence_credits_admin_token"
                       value="{{.Cfg.Presence.CreditsAdminToken}}"
                       placeholder="Bearer token for admin endpoints">
                <button type="button" class="btn token-btn" onclick="generateToken('svc-credits-token')" title="Generate random token">Generate</button>
                <button type="button" class="btn token-btn" onclick="copyToken('svc-credits-token')" title="Copy token to clipboard">Copy</button>
              </div>
              <div class="hint">
                Set the same token as <code>admin_token</code> in the credits service's config.json.
                Required for the admin dashboard to read account data.
              </div>
            </div>
          </div>

          <!-- Email tab -->
          <div class="svc-tab-panel" data-svc="email">
            <div class="field">
              <label>Service URL <span id="svc-email-status" class="svc-status"></span></label>
              <div class="token-field">
                <input id="svc-email-url" name="presence_email_url"
                       value="{{.Cfg.Presence.EmailURL}}"
                       placeholder="http://localhost:8802">
                <button type="button" class="btn token-btn svc-check-btn" data-svc-check="email" style="display:none">Check</button>
              </div>
              <div class="hint">
                Centralizes SMTP sending and HTML email templates.
                Point the registration service's <code>email_url</code> to this service for verification emails.
              </div>
            </div>
          </div>

          <!-- Templates tab -->
          <div class="svc-tab-panel" data-svc="templates">
            <div class="field">
              <label>Service URL <span id="svc-templates-status" class="svc-status"></span></label>
              <div class="token-field">
                <input id="svc-templates-url" name="presence_templates_url"
                       value="{{.Cfg.Presence.TemplatesURL}}"
                       placeholder="http://localhost:8803">
                <button type="button" class="btn token-btn svc-check-btn" data-svc-check="templates" style="display:none">Check</button>
              </div>
              <div class="hint">
                Manages store templates, bundles, and pricing.
                When configured, templates are served from this service instead of the embedded defaults.
              </div>
            </div>
            <div class="field" style="margin-top:10px">
              <label>Admin Token</label>
              <div class="token-field">
                <input id="svc-templates-token" name="presence_templates_admin_token"
                       value="{{.Cfg.Presence.TemplatesAdminToken}}"
                       placeholder="Bearer token for admin endpoints">
                <button type="button" class="btn token-btn" onclick="generateToken('svc-templates-token')" title="Generate random token">Generate</button>
                <button type="button" class="btn token-btn" onclick="copyToken('svc-templates-token')" title="Copy token to clipboard">Copy</button>
              </div>
              <div class="hint">
                Set the same token as <code>admin_token</code> in the templates service's config.json.
                Required for managing template prices.
              </div>
            </div>
          </div>
          </div><!-- /svc-body -->

        </div>

        <!-- Scripting (peer only) -->
        {{if not .RendezvousOnly}}
        <div class="settings-section" data-section="scripting">
          <h3 class="settings-section-title">Lua Scripting</h3>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="muted small">Off</span>
            <label class="switch" title="Enable Lua chat scripts">
              <input type="checkbox" name="lua_enabled"
                     {{if .Cfg.Lua.Enabled}}checked{{end}}>
              <span class="slider"></span>
            </label>
            <span class="muted small">On</span>
          </div>
          <div class="hint">
            When enabled, peers can run !commands defined in your <code>{{.Cfg.Lua.ScriptDir}}</code> folder.
            {{if .Cfg.Lua.Enabled}}<a href="/lua">Manage scripts</a>{{end}}
          </div>
        </div>
        {{end}}

        <!-- Save bar -->
        <div class="settings-save-bar" id="settings-save-bar">
          <button class="btn" type="submit">Save</button>
          <span class="muted small">Changing networking or viewer settings may require a restart.</span>
        </div>
      </form>

      <!-- Data (peer only, outside form) -->
      {{if not .RendezvousOnly}}
      <div class="settings-section" data-section="data">
        <h3 class="settings-section-title">Import / Export</h3>
        <p class="muted small">Export your site as a .zip archive (files, database, lua scripts) or import one to restore.</p>
        <div style="display:flex;gap:0.75rem;margin-top:0.5rem;flex-wrap:wrap;">
          <button type="button" class="btn secondary" id="export-btn">Export site (.zip)</button>
          <button type="button" class="btn secondary" id="import-btn">Import site (.zip)</button>
          <input type="file" id="import-file" accept=".zip" style="display:none">
        </div>
      </div>
      {{end}}
    </div>
  </div>
</div>
{{end}}
