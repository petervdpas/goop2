<!-- internal/ui/templates/logs.html -->
{{define "page.logs"}}
<div style="display:flex; justify-content:space-between; align-items:center;">
  <h1 style="margin:0;">Logs</h1>
  <button id="copyLogsBtn" class="btn btn-sm" title="Copy logs to clipboard" style="padding:6px 12px; font-size:12px;">
    Copy
  </button>
</div>

<p class="muted small">Live tail from this Go process.</p>

<pre id="logbox" class="content" style="height:70vh; overflow:auto; white-space:pre-wrap;"></pre>

<script>
(() => {
  const box = document.getElementById("logbox");
  const copyBtn = document.getElementById("copyLogsBtn");
  const maxChars = 200000;

  function appendLine(s) {
    if (!s) return;
    box.textContent += s + "\n";
    if (box.textContent.length > maxChars) {
      box.textContent = box.textContent.slice(box.textContent.length - maxChars);
    }
    box.scrollTop = box.scrollHeight;
  }

  // Copy button handler
  copyBtn.addEventListener("click", () => {
    const text = box.textContent;
    navigator.clipboard.writeText(text).then(() => {
      const orig = copyBtn.textContent;
      copyBtn.textContent = "Copied!";
      setTimeout(() => { copyBtn.textContent = orig; }, 2000);
    }).catch(err => {
      // Fallback for older browsers or if clipboard API fails
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.opacity = "0";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        const orig = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => { copyBtn.textContent = orig; }, 2000);
      } catch(e) {
        alert("Failed to copy: " + e.message);
      }
      document.body.removeChild(textarea);
    });
  });

  // Load snapshot then stream.
  fetch("/api/logs")
    .then(r => r.json())
    .then(items => {
      for (const it of items) {
        // it.ts is RFC3339-ish; keep it short.
        appendLine(it.msg);
      }
      const es = new EventSource("/api/logs/stream");
      es.addEventListener("message", (ev) => {
        try {
          const it = JSON.parse(ev.data);
          appendLine(it.msg);
        } catch {
          appendLine(ev.data);
        }
      });
      es.onerror = () => {
        // silently let browser auto-retry
      };
    })
    .catch(err => appendLine("logs error: " + err));
})();
</script>
{{end}}
