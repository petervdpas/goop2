{{define "page.peer"}}
<div class="peer-page">
<p>
  <a class="back" href="/peers">&larr; back</a>
</p>

<div class="card peer-detail-card">
  <img class="avatar avatar-lg"
       src="/api/avatar/peer/{{.PeerID}}{{if .AvatarHash}}?v={{.AvatarHash}}{{end}}"
       alt="">
  <div class="peer-detail-info">
    <div class="peer-detail-name" id="peer-name">
      <span class="loading-text">Loading...</span>
    </div>
    <div class="muted small">
      {{if .PeerEmail}}{{.PeerEmail}} &middot; {{end}}<code>{{.PeerID}}</code>
    </div>
  </div>
  <a class="btn identity-site-btn"
     href="{{printf "%s/p/%s/" .BaseURL .PeerID}}"
     onclick="return openExternal(this.href)"
     rel="noopener">Open site</a>
</div>

<div class="chat-header">
  <h2 style="margin:0;">Chat</h2>
  <div class="chat-call-actions">
    {{if or .VideoDisabled .SelfVideoDisabled}}
    <span class="peer-video-disabled" title="Video/audio calls disabled" style="display:flex;align-items:center;gap:4px;color:#f39c12;font-size:12px;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      Calls disabled
    </span>
    {{else}}
    <button class="call-btn" id="btn-audio-call" title="Voice call">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.8.3 1.58.52 2.34a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.76.22 1.54.4 2.34.52A2 2 0 0 1 22 16.92z"/>
      </svg>
    </button>
    <button class="call-btn" id="btn-video-call" title="Video call">
      <svg width="20" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="23 7 16 12 23 17 23 7"/>
        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
      </svg>
    </button>
    {{end}}
  </div>
</div>
<div class="chat-container">
  <div class="chat-messages" id="chat-messages">
    <p class="muted"><i>Loading messages...</i></p>
  </div>
  {{if .LuaEnabled}}
  <div class="chat-lua-hint">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    Messages starting with <code>!</code> are processed as Lua commands by the remote peer
  </div>
  {{end}}
  <form class="chat-input" id="chat-form">
    <input type="text" id="chat-message" placeholder="Type a message..." autocomplete="off" required>
    <button type="submit">Send</button>
  </form>
</div>
</div>

<script>
(function() {
  const peerID = {{.PeerID}};
  const messagesDiv = document.getElementById('chat-messages');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-message');

  // Load peer content (display name) in background
  const peerNameEl = document.getElementById('peer-name');
  fetch('/api/peer/content?id=' + encodeURIComponent(peerID))
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.content) {
        peerNameEl.textContent = data.content;
      } else {
        peerNameEl.textContent = peerID;
      }
    })
    .catch(function() {
      peerNameEl.textContent = peerID;
    });

  // Load existing messages
  async function loadMessages() {
    try {
      const res = await fetch(`/api/chat/messages?peer=${encodeURIComponent(peerID)}`);
      const messages = await res.json();
      renderMessages(messages);
    } catch (err) {
      console.error('Failed to load messages:', err);
      messagesDiv.innerHTML = '<p class="error">Failed to load messages</p>';
    }
  }

  // Render messages
  function renderMessages(messages) {
    if (messages.length === 0) {
      messagesDiv.innerHTML = '<p class="muted"><i>No messages yet. Start a conversation!</i></p>';
      return;
    }

    messagesDiv.innerHTML = messages.map(msg => {
      const time = new Date(msg.timestamp).toLocaleString();
      const isOutgoing = msg.from !== peerID;
      const className = isOutgoing ? 'msg-out' : 'msg-in';
      const avatarUrl = isOutgoing
        ? '/api/avatar'
        : '/api/avatar/peer/' + encodeURIComponent(peerID);
      const converted = emojify(msg.content);
      const emojiOnly = isEmojiOnly(converted) ? ' msg-emoji-only' : '';
      return `<div class="chat-msg ${className}">
        <img class="avatar avatar-xs chat-msg-avatar" src="${avatarUrl}" alt="">
        <div class="chat-msg-body">
          <div class="msg-content${emojiOnly}">${escapeHtml(converted)}</div>
          <div class="msg-time">${time}</div>
        </div>
      </div>`;
    }).join('');

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Send message
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = input.value.trim();
    if (!content) return;

    try {
      const res = await fetch('/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: peerID, content })
      });

      if (res.ok) {
        input.value = '';
        loadMessages(); // Reload to show sent message
      } else {
        alert('Failed to send message');
      }
    } catch (err) {
      console.error('Failed to send:', err);
      alert('Failed to send message');
    }
  });

  // Listen for new messages via SSE
  const eventSource = new EventSource('/api/chat/events');
  eventSource.addEventListener('message', (e) => {
    const msg = JSON.parse(e.data);
    // Only update if this message is part of this conversation
    if (msg.from === peerID || msg.to === peerID) {
      loadMessages();
    }
  });

  eventSource.onerror = () => {
    console.error('SSE connection lost, reconnecting...');
  };

  var escapeHtml = window.Goop && window.Goop.core ? window.Goop.core.escapeHtml : function(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };

  function emojify(text) {
    return window.Goop && window.Goop.emoji ? window.Goop.emoji.emojify(text) : text;
  }

  function isEmojiOnly(text) {
    return window.Goop && window.Goop.emoji ? window.Goop.emoji.isEmojiOnly(text) : false;
  }

  // ── Call buttons ──
  var audioBtn = document.getElementById('btn-audio-call');
  var videoBtn = document.getElementById('btn-video-call');
  var inCall = false;

  function setCallBusy(busy) {
    inCall = busy;
    if (audioBtn) { audioBtn.disabled = busy; audioBtn.classList.toggle('busy', busy); }
    if (videoBtn) { videoBtn.disabled = busy; videoBtn.classList.toggle('busy', busy); }
  }

  // Check if already in a call with this peer on load
  if (window.Goop && window.Goop.call) {
    var existing = Goop.call.activeCalls();
    for (var i = 0; i < existing.length; i++) {
      if (existing[i].remotePeer === peerID) {
        setCallBusy(true);
        existing[i].onHangup(function() { setCallBusy(false); });
        break;
      }
    }
  }

  function startCall(constraints) {
    if (!window.Goop || !window.Goop.callUI) {
      alert('Call feature not available');
      return;
    }
    if (inCall) return;
    setCallBusy(true);

    Goop.callUI.startCall(peerID, constraints).then(function(session) {
      session.onHangup(function() { setCallBusy(false); });
    }).catch(function(err) {
      console.error('Call failed:', err);
      setCallBusy(false);
    });
  }

  if (audioBtn) {
    audioBtn.addEventListener('click', function() {
      startCall({ audio: true, video: false });
    });
  }

  if (videoBtn) {
    videoBtn.addEventListener('click', function() {
      startCall({ audio: true, video: true });
    });
  }

  // Initial load
  loadMessages();
})();
</script>
{{end}}
