<!-- internal/ui/templates/layout.html -->
{{define "layout"}}
<!DOCTYPE html>
<html data-theme="{{.Theme}}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.Title}}</title>

    <link rel="stylesheet" href="/assets/vendor/codemirror/codemirror.css" />
    <link rel="stylesheet" href="/assets/vendor/codemirror/theme/xq-dark.css" />
    <link rel="stylesheet" href="/assets/vendor/codemirror/theme/xq-light.css" />

    <script defer src="/assets/vendor/codemirror/codemirror.js"></script>
    <script defer src="/assets/vendor/codemirror/mode/xml.js"></script>
    <script defer src="/assets/vendor/codemirror/mode/javascript.js"></script>
    <script defer src="/assets/vendor/codemirror/mode/css.js"></script>
    <script defer src="/assets/vendor/codemirror/mode/htmlmixed.js"></script>
    <script defer src="/assets/vendor/codemirror/mode/lua.js"></script>

    <link rel="stylesheet" href="/assets/app.css" />
    <script src="/assets/app.js"></script>
    <script>
    function openExternal(url){
      var b=new URLSearchParams(location.search).get('bridge');
      if(b){fetch(b+'/open?url='+encodeURIComponent(url),{method:'POST'});return false;}
      location.href='/open?url='+encodeURIComponent(url);return false;
    }
    </script>
    
    {{if .SelfID}}
    <!-- Global chat notifications -->
    <script>
    (function() {
      const selfID = '{{.SelfID}}';
      if (!window.Goop) window.Goop = {};

      // Track current peer page to avoid duplicate notifications
      let currentPeerPage = null;
      const pathMatch = window.location.pathname.match(/\/peer\/([^/]+)/);
      if (pathMatch) {
        currentPeerPage = pathMatch[1];
      }

      function initChatNotifications() {
        if (!window.Goop || !window.Goop.toast) {
          setTimeout(initChatNotifications, 100);
          return;
        }

        const eventSource = new EventSource('/api/chat/events');

        eventSource.addEventListener('message', function(e) {
          try {
            const msg = JSON.parse(e.data);
            const msgType = msg.type || 'direct';

            // Only show toast for:
            // - direct messages (not broadcast)
            // - incoming messages (sender is not us)
            // - when NOT on the sender's peer page (chat window closed)
            if (msgType === 'direct' && msg.from && msg.from !== selfID && msg.from !== currentPeerPage) {
              var avatarUrl = '/api/avatar/peer/' + encodeURIComponent(msg.from);
              var avatarImg = '<img src="' + avatarUrl + '" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">';

              // Try to get a friendly name from the peers API
              fetch('/api/peers').then(function(r){ return r.json(); }).then(function(peers) {
                var label = msg.from.substring(0, 8) + '...';
                if (Array.isArray(peers)) {
                  var found = peers.find(function(p){ return p.ID === msg.from; });
                  if (found && found.Content) label = found.Content;
                }

                var preview = msg.content;
                if (preview.length > 60) preview = preview.substring(0, 60) + '...';

                window.Goop.toast({
                  icon: avatarImg,
                  title: label,
                  message: '<div>' + preview.replace(/</g,'&lt;') + '</div>',
                  onClick: function() {
                    window.location.href = '/peer/' + msg.from;
                  },
                  duration: 8000
                });
              }).catch(function() {
                var shortID = msg.from.substring(0, 8) + '...';
                var preview = msg.content;
                if (preview.length > 60) preview = preview.substring(0, 60) + '...';

                window.Goop.toast({
                  icon: avatarImg,
                  title: shortID,
                  message: '<div>' + preview.replace(/</g,'&lt;') + '</div>',
                  onClick: function() {
                    window.location.href = '/peer/' + msg.from;
                  },
                  duration: 8000
                });
              });
            }
          } catch (err) {
            console.error('Failed to parse chat message:', err);
          }
        });

        eventSource.onerror = function(err) {
          console.error('Chat SSE error:', err);
        };
      }

      initChatNotifications();
    })();
    </script>
    {{end}}
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <span class="logo">Goop²</span>
          <span class="tag">ephemeral web</span>
        </div>

        {{/* Viewer-only chrome: nav + self info */}}
        {{if .SelfID}}
          <nav class="topnav">
            <a class="navitem {{if isActive .Active "peers"}}active{{end}}" href="{{.BaseURL}}/peers">Peers</a>
            <a class="navitem {{if isActive .Active "self"}}active{{end}}" href="{{.BaseURL}}/self">Me</a>
            <a class="navitem {{if isActive .Active "create"}}active{{end}}" href="{{.BaseURL}}/create">Create</a>
            <a class="navitem {{if isActive .Active "database"}}active{{end}}" href="{{.BaseURL}}/database">Database</a>
            <a class="navitem {{if isActive .Active "documents"}}active{{end}}" href="{{.BaseURL}}/documents">Files</a>
            <a class="navitem {{if isActive .Active "logs"}}active{{end}}" href="{{.BaseURL}}/logs">Logs</a>
          </nav>

          <div class="topright">
            <div class="theme">
              <span class="theme-label small muted">Theme</span>
              <label class="switch" title="Toggle light/dark">
                <input id="themeToggle" type="checkbox" aria-label="Toggle theme" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="me">
              <span class="me-label">{{.SelfName}}</span>
              <span class="me-id"><code>{{.SelfID}}</code></span>
            </div>
          </div>
        {{else if .RendezvousOnly}}
          {{/* Rendezvous-only chrome: limited nav */}}
          <nav class="topnav">
            <a class="navitem {{if isActive .Active "self"}}active{{end}}" href="{{.BaseURL}}/self">Settings</a>
            <a class="navitem {{if isActive .Active "logs"}}active{{end}}" href="{{.BaseURL}}/logs">Logs</a>
          </nav>

          <div class="topright">
            <div class="theme">
              <span class="theme-label small muted">Theme</span>
              <label class="switch" title="Toggle light/dark">
                <input id="themeToggle" type="checkbox" aria-label="Toggle theme" />
                <span class="slider"></span>
              </label>
            </div>

            {{if .SelfName}}
            <div class="me">
              <span class="me-label">{{.SelfName}}</span>
            </div>
            {{end}}
          </div>
        {{else}}
          {{/* Launcher-only chrome: just theme toggle (optional) */}}
          <div class="topright">
            <div class="theme">
              <span class="theme-label small muted">Theme</span>
              <label class="switch" title="Toggle light/dark">
                <input id="themeToggle" type="checkbox" aria-label="Toggle theme" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        {{end}}
      </header>

      <main class="main">
        <div class="content">{{ include .ContentTmpl . }}</div>
      </main>

      <footer class="footer">
        <div class="footer-inner">
          <span class="muted small">Goop²</span>
          <span class="muted small">·</span>
          <span class="muted small">ephemeral web</span>
          {{if .Debug}}
          <span class="muted small">·</span>
          <a href="#" onclick="return openExternal(location.href)" class="muted small" style="text-decoration: none;" title="Open in browser">Debug</a>
          {{end}}
        </div>
      </footer>
    </div>
  </body>
</html>
{{end}}
