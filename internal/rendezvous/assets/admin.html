<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{.Title}}</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/assets/style.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="logo">üì°</div>
        <div>
          <h1>{{.Title}}</h1>
          <p class="subtitle"><span class="live-dot"></span>Live dashboard</p>
        </div>
      </div>
      <div class="header-right">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <span class="theme-icon">üåô</span>
        </button>
        <a class="nav-link" href="/docs">Docs</a>
        <a class="nav-link" href="/">Public</a>
      </div>
    </header>

    <div class="admin-layout">
      <!-- Sidebar -->
      <nav class="admin-sidebar glass">
        <div class="admin-sidebar-title">Admin</div>
        <ul class="admin-nav">
          <li class="admin-nav-item active" data-section="overview">Overview</li>
          <li class="admin-nav-item" data-section="peers">Peers <span class="nav-count" id="nav-peer-count">({{.PeerCount}})</span></li>
          {{if .HasRegistrations}}<li class="admin-nav-item" data-section="registrations">Registrations <span class="nav-count" id="nav-reg-count"></span></li>{{end}}
          {{if .HasAccounts}}<li class="admin-nav-item" data-section="accounts">Accounts <span class="nav-count" id="nav-acc-count"></span></li>{{end}}
          {{if .HasCredits}}<li class="admin-nav-item" data-section="prices">Prices</li>{{end}}
          <li class="admin-nav-item" data-section="logs">Logs</li>
        </ul>
      </nav>

      <!-- Main content -->
      <div class="admin-main">

        <!-- ‚îÄ‚îÄ Overview ‚îÄ‚îÄ -->
        <div class="admin-section active" data-section="overview">
          <div class="hero-row">
            <div class="hero-card glass">
              <div class="hero-number" id="count">{{.PeerCount}}</div>
              <div class="hero-label">Connected Peers</div>
            </div>
            <div class="hero-card glass">
              <div class="hero-number" id="clock">{{.Now}}</div>
              <div class="hero-label">Server Time</div>
            </div>
          </div>

          {{if or .ServiceRows .HasRelay}}
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Services</span>
            </div>
            <div class="svc-list">
              {{if .HasRelay}}
              <div class="svc-topo-group">
                <div class="svc-row">
                  <div class="svc-row-left">
                    <span class="svc-dot svc-dot-ok"></span>
                    <strong>Relay</strong>
                    <span class="svc-badge svc-badge-ok">(active)</span>
                  </div>
                  <div class="svc-row-right">
                    <span>port {{.RelayPort}}</span>
                    <code style="font-size:11px">{{.RelayPeerID}}</code>
                  </div>
                </div>
              </div>
              {{end}}
              {{range .ServiceRows}}
              <div class="svc-topo-group">
                <div class="svc-row"{{if .Dependencies}} style="border-bottom:none;padding-bottom:0"{{end}}>
                  <div class="svc-row-left">
                    <span class="svc-dot {{if not .OK}}svc-dot-err{{else if not .APICompat}}svc-dot-err{{else}}svc-dot-ok{{end}}"></span>
                    <strong>{{.Name}}</strong>
                    {{if .OK}}
                      {{if .DummyMode}}<span class="svc-badge svc-badge-dummy">(dummy)</span>
                      {{else}}<span class="svc-badge svc-badge-ok">(active)</span>{{end}}
                    {{else}}<span class="svc-badge svc-badge-err">not running</span>{{end}}
                    {{if and .OK (not .APICompat)}}<span class="svc-badge svc-badge-err">&#9888; Incompatible API</span>{{end}}
                  </div>
                  <div class="svc-row-right">
                    {{if .OK}}{{if .Version}}<span>v{{.Version}}</span>{{end}}<span>API v{{.APIVersion}}</span>{{end}}
                    <span>{{.URL}}</span>
                  </div>
                </div>
                {{range .Dependencies}}
                <div class="svc-row svc-dep-row" style="padding-left:2rem;padding-top:0.2rem;padding-bottom:0.2rem">
                  <div class="svc-row-left">
                    <span class="svc-dot {{if .OK}}svc-dot-ok{{else}}svc-dot-err{{end}}"></span>
                    <span>&#8594; {{.Name}}</span>
                    {{if .Error}}<span class="svc-badge svc-badge-err">{{.Error}}</span>{{end}}
                  </div>
                  <div class="svc-row-right">
                    <code>{{if .URL}}{{.URL}}{{else}}(empty){{end}}</code>
                  </div>
                </div>
                {{end}}
              </div>
              {{end}}
            </div>
          </div>
          {{end}}

          {{if .ChainIssues}}
          <div class="dash-panel glass" style="margin-top:.75rem">
            <div class="dash-panel-header">
              <span class="dash-panel-label">&#9888; Chain Issues</span>
            </div>
            <div class="svc-list">
              {{range .ChainIssues}}
              <div class="svc-row" style="color:var(--danger,#e74c3c)">
                <div class="svc-row-left">{{.}}</div>
              </div>
              {{end}}
            </div>
          </div>
          {{end}}
        </div>

        <!-- ‚îÄ‚îÄ Peers ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="peers">
          <div class="search-bar">
            <span class="search-icon">&#x1F50D;</span>
            <input id="q" class="search-input" placeholder="Filter peers..." />
          </div>

          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label"><span class="live-dot"></span> Peers</span>
            </div>
            <div id="peers-container">
              {{if eq (len .Peers) 0}}
              <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <p>No peers connected yet</p>
                <p class="empty-hint">Peers will appear here once they connect</p>
              </div>
              {{else}}
              <div class="peer-grid" id="peer-grid">
                {{range .Peers}}
                <div class="peer-card peer-row" data-status="{{statusClass .Type}}" data-label="{{.Content}}" data-email="{{.Email}}">
                  <div class="peer-header">
                    <span class="status-badge {{statusClass .Type}}">{{.Type}}</span>
                    <span class="peer-time">{{fmtMillis .LastSeen}}</span>
                  </div>
                  <div class="peer-label">{{.Content}}{{if not .Verified}} <span class="badge-unverified">unverified</span>{{end}}</div>
                  {{if .Email}}<div class="peer-email">{{.Email}}</div>{{end}}
                  <div class="peer-id">{{.PeerID}}</div>
                  {{if .Addrs}}<details class="peer-addrs-details"><summary class="peer-addrs-summary">{{len .Addrs}} address{{if ne (len .Addrs) 1}}es{{end}}</summary><div class="peer-addrs">{{range .Addrs}}<div class="peer-addr">{{.}}</div>{{end}}</div></details>{{end}}
                  <div class="peer-stats">
                    <span class="stat-item" title="Sent">‚Üë {{fmtBytes .BytesSent}}</span>
                    <span class="stat-item" title="Received">‚Üì {{fmtBytes .BytesReceived}}</span>
                    <button class="btn-copy-peer" onclick="diagnosePeer('{{.PeerID}}','{{.Content}}')">Diagnose</button>
                  </div>
                </div>
                {{end}}
              </div>
              {{end}}
            </div>
          </div>
        </div>

        {{if .HasRegistrations}}
        <!-- ‚îÄ‚îÄ Registrations ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="registrations">
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Registrations</span>
            </div>
            <div id="reg-body">
              <div class="admin-placeholder">Loading...</div>
            </div>
          </div>
        </div>
        {{end}}

        {{if .HasAccounts}}
        <!-- ‚îÄ‚îÄ Credit Accounts ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="accounts">
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Credit Accounts</span>
            </div>
            <div id="acc-body">
              <div class="admin-placeholder">Loading...</div>
            </div>
          </div>
        </div>
        {{end}}

        {{if .HasCredits}}
        <!-- ‚îÄ‚îÄ Prices ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="prices">
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Template Prices</span>
            </div>
            <div id="prices-body">
              <div class="admin-placeholder">Loading...</div>
            </div>
          </div>
        </div>
        {{end}}

        <!-- ‚îÄ‚îÄ Logs ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="logs">
          <div class="log-tab-bar">
            <button class="btn log-tab active" data-log-tab="rendezvous" onclick="switchLogTab('rendezvous')">Rendezvous</button>
            {{if .HasRelay}}<button class="btn log-tab" data-log-tab="relay" onclick="switchLogTab('relay')">Relay</button>{{end}}
            {{if .Services}}<button class="btn log-tab" data-log-tab="services" onclick="switchLogTab('services')">Services</button>{{end}}
          </div>
          <div class="dash-panel glass" data-log-panel="rendezvous">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Rendezvous Logs</span>
            </div>
            <div class="logs-container" id="logs-container">
              <div class="log-entry empty">Loading...</div>
            </div>
          </div>
          {{if .HasRelay}}
          <div class="dash-panel glass" data-log-panel="relay" style="display:none">
            <div class="dash-panel-header">
              <span class="dash-panel-label"><span class="live-dot"></span> Relay ‚Äî <span id="relay-peer-count">0</span> peers</span>
              <button class="btn btn-sm" onclick="copyRelayStatus()" title="Copy relay status to clipboard">Copy</button>
            </div>
            <div id="relay-peers-container" style="padding:0 12px 8px"></div>
            <div class="logs-container" id="relay-logs-container">
              <div class="log-entry empty">Loading...</div>
            </div>
          </div>
          {{end}}
          {{if .Services}}
          <div class="dash-panel glass" data-log-panel="services" style="display:none">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Service Logs</span>
            </div>
            <div class="logs-container" id="svc-logs-container">
              <div class="log-entry empty">Loading...</div>
            </div>
          </div>
          {{end}}
        </div>

        <!-- ‚îÄ‚îÄ Peer Diagnostics (hidden, shown via Diagnose button) ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="diag" style="display:none">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <button class="btn" onclick="closeDiag()">Back</button>
            <h2 id="diag-title" style="margin:0">Peer Diagnostics</h2>
            <button class="btn btn-sm" id="diag-refresh-btn" onclick="refreshDiag()" style="margin-left:auto">Refresh</button>
            <button class="btn btn-sm" onclick="copyDiagResult()">Copy</button>
          </div>
          <div id="diag-view">
            <div style="padding:24px;color:var(--muted)">Querying peer via relay...</div>
          </div>
        </div>

      </div>
    </div>

    <script>
      function formatBytes(b) {
        if (b < 1024) return b + ' B';
        if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
        if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
        return (b / 1073741824).toFixed(1) + ' GB';
      }

      function fmtDate(v) {
        if (!v) return '';
        if (typeof v === 'number') return new Date(v).toLocaleString();
        var d = new Date(v.indexOf('T') === -1 ? v.replace(' ', 'T') + 'Z' : v);
        return isNaN(d.getTime()) ? v : d.toLocaleString();
      }

      var palette = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63','#00bcd4','#ff5722','#607d8b','#795548','#8bc34a','#673ab7'];
      function hash(s){var h=0;for(var i=0;i<s.length;i++)h=((h<<5)-h+s.charCodeAt(i))|0;return Math.abs(h);}
      function initials(l){l=(l||'').trim();if(!l)return '?';var p=l.split(/\s+/);return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():l.substring(0,Math.min(2,l.length)).toUpperCase();}
      function avatarURI(l,e){var c=palette[hash((l||'')+(e||''))%palette.length];return 'data:image/svg+xml;base64,'+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="'+c+'"/><text x="18" y="18" dy=".35em" text-anchor="middle" font-family="sans-serif" font-size="14" font-weight="600" fill="#fff">'+initials(l)+'</text></svg>');}

      // Theme
      (function(){
        var t=document.getElementById('themeToggle'),i=t.querySelector('.theme-icon'),h=document.documentElement,s=localStorage.getItem('theme')||'dark';
        h.setAttribute('data-theme',s);i.textContent=s==='dark'?'‚òÄÔ∏è':'üåô';
        t.onclick=function(){s=h.getAttribute('data-theme')==='dark'?'light':'dark';h.setAttribute('data-theme',s);localStorage.setItem('theme',s);i.textContent=s==='dark'?'‚òÄÔ∏è':'üåô';};
      })();

      // Live clock
      (function(){
        var el=document.getElementById('clock');
        if(!el)return;
        function tick(){var d=new Date();el.textContent=d.toLocaleTimeString();}
        tick();setInterval(tick,1000);
      })();

      // ‚îÄ‚îÄ Sidebar navigation ‚îÄ‚îÄ
      (function(){
        var items = document.querySelectorAll('.admin-nav-item');
        var sections = document.querySelectorAll('.admin-section');
        var loaded = {};

        items.forEach(function(item){
          item.addEventListener('click', function(){
            var target = item.getAttribute('data-section');
            items.forEach(function(n){ n.classList.remove('active'); });
            item.classList.add('active');
            sections.forEach(function(s){
              s.classList.toggle('active', s.getAttribute('data-section') === target);
            });
            // Lazy-load data sections on first visit
            if (target === 'registrations' && !loaded.reg) { loaded.reg = true; loadRegistrations(); }
            if (target === 'accounts' && !loaded.acc)       { loaded.acc = true; loadAccounts(); }
            if (target === 'prices' && !loaded.prices)      { loaded.prices = true; loadPrices(); }
            if (target === 'logs' && !loaded.logs)          { loaded.logs = true; updateLogs(); if(window.updateServiceLogs) updateServiceLogs(); if(window.updateRelay) updateRelay(); }
          });
        });
      })();

      // ‚îÄ‚îÄ Live data (only polls the active section) ‚îÄ‚îÄ
      (function(){
        var R=2000;

        // Track which admin section is currently visible.
        var activeSection = 'overview';
        var origClick = document.querySelectorAll('.admin-nav-item');
        origClick.forEach(function(item){
          if(item.classList.contains('active')) activeSection = item.getAttribute('data-section');
          item.addEventListener('click', function(){ activeSection = item.getAttribute('data-section'); });
        });
        // Expose setter so diagnosePeer/closeDiag can update the active section.
        window._setActiveSection = function(s){ activeSection = s; };

        async function updatePeers(){
          if(document.hidden)return;
          // Always update peer count (shown on overview), but skip full render unless on peers section
          try{
            var r=await fetch('/peers.json'),d=await r.json();
            document.getElementById('count').textContent=d.length;
            var nc=document.getElementById('nav-peer-count');if(nc)nc.textContent='('+d.length+')';
            if(activeSection!=='peers')return;
            var q=document.getElementById('q');if(q&&q===document.activeElement)return;
            var c=document.getElementById('peers-container');if(!c)return;
            if(!d.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üì≠</div><p>No peers connected yet</p><p class="empty-hint">Peers will appear here once they connect</p></div>';return;}
            c.innerHTML='<div class="peer-grid" id="peer-grid">'+d.map(function(p){
              var sc=p.type==='online'?'on':(p.type==='offline'?'off':'up');
              var ls=p.last_seen?new Date(p.last_seen).toLocaleString():'';
              var av=avatarURI(p.content||'',p.email||'');
              var unverifiedBadge = p.verified ? '' : ' <span class="badge-unverified">unverified</span>';
              var addrsHtml = '';
              if(p.addrs&&p.addrs.length){
                addrsHtml='<details class="peer-addrs-details"><summary class="peer-addrs-summary">'+p.addrs.length+' address'+(p.addrs.length!==1?'es':'')+'</summary><div class="peer-addrs">'+p.addrs.map(function(a){return '<div class="peer-addr">'+a+'</div>';}).join('')+'</div></details>';
              }
              return '<div class="peer-card peer-row" data-status="'+sc+'" data-label="'+(p.content||'')+'">'
                +'<div class="peer-header"><img class="peer-avatar" src="'+av+'" width="28" height="28"><span class="status-badge '+sc+'">'+p.type+'</span><span class="peer-time">'+ls+'</span></div>'
                +'<div class="peer-label">'+(p.content||'Unknown')+unverifiedBadge+'</div>'
                +(p.email?'<div class="peer-email">'+p.email+'</div>':'')
                +'<div class="peer-id">'+p.peer_id+'</div>'
                +addrsHtml
                +'<div class="peer-stats"><span class="stat-item">‚Üë '+formatBytes(p.bytes_sent||0)+'</span><span class="stat-item">‚Üì '+formatBytes(p.bytes_received||0)+'</span><button class="btn-copy-peer" onclick="diagnosePeer(\''+p.peer_id+'\',\''+(p.content||'').replace(/\'/g,'')+'\')">Diagnose</button></div>'
                +'</div>';
            }).join('')+'</div>';
            applyFilter();
          }catch(e){console.error(e);}
        }
        window.updatePeers = updatePeers;
        setInterval(updatePeers,R);

        window.updateLogs = async function updateLogs(){
          if(activeSection!=='logs')return;
          try{
            var r=await fetch('/logs.json'),l=await r.json(),c=document.getElementById('logs-container');if(!c)return;
            if(!l.length){c.innerHTML='<div class="log-entry empty">No logs yet</div>';return;}
            c.innerHTML=l.reverse().map(function(x){return '<div class="log-entry">'+x+'</div>';}).join('');
          }catch(e){console.error(e);}
        };
        setInterval(updateLogs,R);

        var svcColors = {credits:'#3498db',registration:'#2ecc71',email:'#e67e22',templates:'#9b59b6'};
        window.updateServiceLogs = async function updateServiceLogs(){
          if(activeSection!=='logs')return;
          try{
            var r=await fetch('/api/services/logs'),d=await r.json(),c=document.getElementById('svc-logs-container');if(!c)return;
            if(!d||!d.length){c.innerHTML='<div class="log-entry empty">No service logs yet</div>';return;}
            c.innerHTML=d.reverse().map(function(x){
              var col=svcColors[x.service]||'var(--text)';
              return '<div class="log-entry"><span class="log-svc-label" style="color:'+col+'">['+x.service+']</span>'+x.message+'</div>';
            }).join('');
          }catch(e){console.error(e);}
        };
        setInterval(updateServiceLogs,R);

        window.updateRelay = async function updateRelay(){
          if(activeSection!=='logs')return;
          var rt=document.querySelector('.log-tab[data-log-tab="relay"]');
          if(!rt||!rt.classList.contains('active'))return;
          try{
            var r=await fetch('/relay-status.json'),d=await r.json();
            var pc=document.getElementById('relay-peer-count');
            if(pc) pc.textContent=d.peers?d.peers.length:0;
            var c=document.getElementById('relay-peers-container');
            window._relayData = d;
            if(c){
              if(!d.peers||!d.peers.length){
                c.innerHTML='<div class="empty-state" style="padding:24px"><div class="empty-icon">üì≠</div><p>No relay peers connected</p></div>';
              } else {
                c.innerHTML='<table class="admin-table"><thead><tr><th>Name</th><th>Peer ID</th><th>Address</th><th>Dir</th></tr></thead><tbody>'
                  +d.peers.map(function(p){
                    return '<tr><td>'+(p.name||'‚Äî')+'</td><td style="font-family:monospace;font-size:11px">'+p.peer_id+'</td><td style="font-family:monospace;font-size:11px">'+p.addr+'</td><td>'+p.dir+'</td></tr>';
                  }).join('')+'</tbody></table>';
              }
            }
            var lc=document.getElementById('relay-logs-container');
            if(lc){
              if(!d.logs||!d.logs.length){
                lc.innerHTML='<div class="log-entry empty">No relay events yet</div>';
              } else {
                lc.innerHTML=d.logs.slice().reverse().map(function(x){return '<div class="log-entry">'+x+'</div>';}).join('');
              }
            }
          }catch(e){console.error(e);}
        };
        setInterval(updateRelay,R);

        var q=document.getElementById('q');
        function applyFilter(){
          if(!q)return;
          var v=(q.value||'').toLowerCase().trim(),c=document.getElementById('peers-container');if(!c)return;
          var rows=c.querySelectorAll('.peer-row'),n=0;
          rows.forEach(function(r){var ok=!v||r.textContent.toLowerCase().indexOf(v)!==-1;r.style.display=ok?'':'none';if(ok)n++;});
          document.getElementById('count').textContent=n;
        }
        window.applyFilter=applyFilter;
        if(q) q.addEventListener('input',applyFilter);

        // Inject avatars on initial server-rendered cards
        document.querySelectorAll('.peer-card[data-label]').forEach(function(card){
          var h=card.querySelector('.peer-header');if(!h||h.querySelector('img'))return;
          var img=document.createElement('img');img.src=avatarURI(card.getAttribute('data-label')||'',card.getAttribute('data-email')||'');
          img.width=28;img.height=28;img.className='peer-avatar';
          h.insertBefore(img,h.firstChild);
        });
      })();

      // ‚îÄ‚îÄ Data loaders ‚îÄ‚îÄ
      function loadRegistrations() {
        fetch('/registrations.json').then(function(r){ return r.json(); }).then(function(data){
          var el = document.getElementById('reg-body');
          var nc = document.getElementById('nav-reg-count');
          if (nc) nc.textContent = '(' + data.length + ')';
          if (!data.length) { el.innerHTML = '<div class="admin-placeholder">No registrations yet</div>'; return; }
          var html = '<table class="admin-table"><thead><tr><th>Email</th><th>Status</th><th>Registered</th><th>Verified</th></tr></thead><tbody>';
          data.forEach(function(r){
            var verified = r.verified_at && r.verified_at > 0;
            var badge = verified ? '<span class="badge badge-verified">verified</span>' : '<span class="badge badge-pending">pending</span>';
            html += '<tr><td>' + (r.email||'') + '</td><td>' + badge + '</td><td>' + fmtDate(r.created_at) + '</td><td>' + (verified ? fmtDate(r.verified_at) : '\u2014') + '</td></tr>';
          });
          html += '</tbody></table>';
          el.innerHTML = html;
        }).catch(function(){
          var el = document.getElementById('reg-body');
          if (el) el.innerHTML = '<div class="admin-error">Failed to load registrations</div>';
        });
      }

      function loadAccounts() {
        fetch('/accounts.json').then(function(r){ return r.json(); }).then(function(data){
          var el = document.getElementById('acc-body');
          var nc = document.getElementById('nav-acc-count');
          if (nc) nc.textContent = '(' + data.length + ')';
          if (!data.length) { el.innerHTML = '<div class="admin-placeholder">No credit accounts yet</div>'; return; }
          var html = '<table class="admin-table"><thead><tr><th>Email</th><th>Balance</th><th>Last Activity</th></tr></thead><tbody>';
          data.forEach(function(a){
            html += '<tr><td>' + (a.email||'') + '</td><td>' + a.balance + '</td><td>' + fmtDate(a.updated_at) + '</td></tr>';
          });
          html += '</tbody></table>';
          el.innerHTML = html;
        }).catch(function(){
          var el = document.getElementById('acc-body');
          if (el) el.innerHTML = '<div class="admin-error">Failed to load accounts</div>';
        });
      }

      function loadPrices() {
        var pb = document.getElementById('prices-body');
        Promise.all([
          fetch('/api/templates/prices').then(function(r){ return r.json(); }),
          fetch('/api/templates').then(function(r){ return r.ok ? r.json() : []; })
        ]).then(function(results){
          var prices = results[0] || {};
          var templates = results[1] || [];
          var allDirs = new Set(Object.keys(prices));
          templates.forEach(function(t){ allDirs.add(t.dir); });

          if (allDirs.size === 0) {
            pb.innerHTML = '<div class="admin-placeholder">No templates available</div>';
            return;
          }

          var tplMap = {};
          templates.forEach(function(t){ tplMap[t.dir] = t; });

          var cards = '';
          allDirs.forEach(function(dir){
            var p = prices[dir] || 0;
            var tpl = tplMap[dir] || {};
            var name = tpl.name || dir;
            var icon = tpl.icon || 'üìÑ';
            var badgeClass = p > 0 ? 'price-badge price-badge-paid' : 'price-badge price-badge-free';
            var badgeText = p > 0 ? p + ' credits' : 'Free';

            cards += '<div class="price-card glass">'
              + '<div class="price-card-head">'
              + '<div class="price-card-icon-row">'
              + '<span class="price-card-icon">' + icon + '</span>'
              + '<div>'
              + '<div class="price-card-name">' + name + '</div>'
              + '<code class="price-card-dir">' + dir + '</code>'
              + '</div>'
              + '</div>'
              + '<span class="' + badgeClass + '" data-badge="' + dir + '">' + badgeText + '</span>'
              + '</div>'
              + '<div class="price-card-body">'
              + '<div class="price-input-wrap">'
              + '<input type="number" min="0" value="' + p + '" data-dir="' + dir + '" class="price-input" />'
              + '<span class="price-input-label">credits</span>'
              + '</div>'
              + '</div>'
              + '</div>';
          });

          pb.innerHTML = '<div class="price-grid">' + cards + '</div>'
            + '<div class="price-save-bar">'
            + '<span class="price-save-status" id="save-status"></span>'
            + '<button class="btn primary" id="save-prices">Save Prices</button>'
            + '</div>';

          document.getElementById('save-prices').onclick = savePrices;

          pb.querySelectorAll('.price-input').forEach(function(inp){
            inp.addEventListener('input', function(){
              var dir = inp.getAttribute('data-dir');
              var v = parseInt(inp.value) || 0;
              var badge = pb.querySelector('[data-badge="' + dir + '"]');
              if (!badge) return;
              if (v > 0) {
                badge.className = 'price-badge price-badge-paid';
                badge.textContent = v + ' credits';
              } else {
                badge.className = 'price-badge price-badge-free';
                badge.textContent = 'Free';
              }
            });
          });
        }).catch(function(e){
          pb.innerHTML = '<div class="admin-error">Failed to load prices: ' + e.message + '</div>';
        });
      }

      function savePrices(){
        var pb = document.getElementById('prices-body');
        var btn = document.getElementById('save-prices');
        var status = document.getElementById('save-status');
        var inputs = pb.querySelectorAll('.price-input');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        status.textContent = '';
        status.className = 'price-save-status';

        var promises = [];
        for (var i = 0; i < inputs.length; i++) {
          (function(inp){
            var dir = inp.getAttribute('data-dir');
            var price = parseInt(inp.value) || 0;
            promises.push(
              fetch('/api/templates/prices', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({template: dir, price: price})
              }).then(function(resp){ return resp.ok; })
                .catch(function(){ return false; })
            );
          })(inputs[i]);
        }

        Promise.all(promises).then(function(results){
          btn.disabled = false;
          btn.textContent = 'Save Prices';
          var ok = results.every(function(r){ return r; });
          if (ok) {
            status.textContent = 'Saved';
            status.className = 'price-save-status price-save-ok';
            setTimeout(function(){ status.textContent = ''; status.className = 'price-save-status'; }, 2000);
          } else {
            status.textContent = 'Some prices failed to save';
            status.className = 'price-save-status price-save-err';
          }
        });
      }

      function switchLogTab(tab){
        document.querySelectorAll('.log-tab').forEach(function(b){
          b.classList.toggle('active', b.getAttribute('data-log-tab')===tab);
        });
        document.querySelectorAll('[data-log-panel]').forEach(function(p){
          p.style.display = p.getAttribute('data-log-panel')===tab ? '' : 'none';
        });
        if(tab==='services' && window.updateServiceLogs) updateServiceLogs();
        if(tab==='relay' && window.updateRelay) updateRelay();
      }

      var _diagPeerID = '';
      var _diagPeerName = '';

      function diagnosePeer(peerID, name){
        _diagPeerID = peerID;
        _diagPeerName = name || peerID.substring(0,12);

        // Deactivate all sections via class (no inline styles ‚Äî keep CSS system intact)
        document.querySelectorAll('.admin-section').forEach(function(s){ s.classList.remove('active'); });
        document.querySelectorAll('.admin-nav-item').forEach(function(n){ n.classList.remove('active'); });
        // Show diag section (not in sidebar, needs inline display + active class)
        var diagSec = document.querySelector('[data-section="diag"]');
        diagSec.style.display = '';
        diagSec.classList.add('active');
        if(window._setActiveSection) window._setActiveSection('diag');

        document.getElementById('diag-title').textContent = 'Diagnostics: ' + _diagPeerName;
        document.getElementById('diag-view').innerHTML = '<div style="padding:24px;color:var(--muted)">Querying peer via relay connection...</div>';
        refreshDiag();
      }

      function refreshDiag(){
        if(!_diagPeerID) return;
        var btn = document.getElementById('diag-refresh-btn');
        if(btn){ btn.disabled=true; btn.textContent='Querying...'; }
        fetch('/diag?peer='+encodeURIComponent(_diagPeerID))
          .then(function(r){
            if(!r.ok) return r.text().then(function(t){ throw new Error(t); });
            return r.json();
          })
          .then(function(d){
            window._lastDiag = d;
            renderDiag(d);
          })
          .catch(function(err){
            document.getElementById('diag-view').innerHTML = '<div class="dash-panel glass" style="padding:16px;color:#f44">Failed: '+err.message+'</div>';
          })
          .finally(function(){
            if(btn){ btn.disabled=false; btn.textContent='Refresh'; }
          });
      }

      function renderDiag(d){
        var v = document.getElementById('diag-view');
        var html = '';

        // Stream error banner (peer doesn't support diag protocol)
        if(d.stream_error){
          html += '<div class="dash-panel glass" style="margin-bottom:16px;padding:12px 16px;color:#f80"><strong>Stream error:</strong> '+d.stream_error+'<br><small style="color:var(--muted)">Peer may be running an older version without diagnostic support. Relay-side info is shown below.</small></div>';
        }

        // ‚îÄ‚îÄ Status cards row ‚îÄ‚îÄ
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">';
        html += '<div class="dash-panel glass" style="padding:14px;text-align:center"><div style="font-size:28px;font-weight:700;color:'+(d.has_circuit?'#4f4':'#f44')+'">'+(d.has_circuit?'YES':'NO')+'</div><div style="font-size:12px;color:var(--muted)">Circuit Address</div></div>';
        html += '<div class="dash-panel glass" style="padding:14px;text-align:center"><div style="font-size:28px;font-weight:700">'+d.relay_conns+'</div><div style="font-size:12px;color:var(--muted)">Relay Connections</div></div>';
        html += '<div class="dash-panel glass" style="padding:14px;text-align:center"><div style="font-size:28px;font-weight:700">'+d.connected_peers+'</div><div style="font-size:12px;color:var(--muted)">Connected Peers</div></div>';
        if(d.uptime) html += '<div class="dash-panel glass" style="padding:14px;text-align:center"><div style="font-size:20px;font-weight:700">'+d.uptime+'</div><div style="font-size:12px;color:var(--muted)">Uptime</div></div>';
        if(d.num_goroutine) html += '<div class="dash-panel glass" style="padding:14px;text-align:center"><div style="font-size:28px;font-weight:700">'+d.num_goroutine+'</div><div style="font-size:12px;color:var(--muted)">Goroutines</div></div>';
        html += '</div>';

        // ‚îÄ‚îÄ System info ‚îÄ‚îÄ
        if(d.hostname||d.os||d.go_version){
          html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">System</span></div>';
          html += '<div style="padding:8px 14px;font-size:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:4px 24px">';
          if(d.hostname) html += '<div><span style="color:var(--muted)">Hostname:</span> <strong>'+d.hostname+'</strong></div>';
          if(d.os) html += '<div><span style="color:var(--muted)">OS/Arch:</span> '+d.os+'/'+d.arch+'</div>';
          if(d.go_version) html += '<div><span style="color:var(--muted)">Go:</span> '+d.go_version+'</div>';
          if(d.started) html += '<div><span style="color:var(--muted)">Started:</span> '+d.started+'</div>';
          if(d.presence_ttl) html += '<div><span style="color:var(--muted)">Presence TTL:</span> '+d.presence_ttl+'</div>';
          html += '<div><span style="color:var(--muted)">Site:</span> '+(d.has_site?'<span style="color:#4f4">enabled</span>':'<span style="color:#f44">disabled</span>')+'</div>';
          html += '</div></div>';
        }

        // ‚îÄ‚îÄ Relay config & peerstore ‚îÄ‚îÄ
        if(d.relay_config){
          html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">Relay Config</span></div>';
          html += '<div style="padding:8px 14px;font-size:12px">';
          html += '<div style="margin-bottom:4px"><span style="color:var(--muted)">Relay Peer ID:</span> <code style="font-size:11px">'+d.relay_config.peer_id+'</code></div>';
          if(d.relay_config.addrs&&d.relay_config.addrs.length){
            html += '<div style="margin-bottom:4px"><span style="color:var(--muted)">Configured addrs:</span></div>';
            d.relay_config.addrs.forEach(function(a){ html += '<div style="padding-left:12px;font-family:monospace;font-size:11px">'+a+'</div>'; });
          }
          // Peerstore addresses ‚Äî critical: if empty, relay addresses have expired
          var psAddrs = d.relay_peerstore_addrs;
          if(psAddrs!==undefined){
            var psColor = (psAddrs&&psAddrs.length>0)?'var(--text)':'#f44';
            var psLabel = (psAddrs&&psAddrs.length>0)?psAddrs.length+' cached':'EMPTY (expired!)';
            html += '<div style="margin-top:6px"><span style="color:var(--muted)">Peerstore addrs:</span> <span style="color:'+psColor+'">'+psLabel+'</span></div>';
            if(psAddrs&&psAddrs.length){
              psAddrs.forEach(function(a){ html += '<div style="padding-left:12px;font-family:monospace;font-size:11px">'+a+'</div>'; });
            }
          }
          html += '</div></div>';
        }

        // ‚îÄ‚îÄ Relay connection details (from peer's perspective) ‚îÄ‚îÄ
        if(d.relay_conn_details&&d.relay_conn_details.length){
          html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">Relay Connections (peer side)</span></div>';
          html += '<table class="admin-table"><thead><tr><th>Address</th><th>Dir</th><th>Age</th><th>Streams</th></tr></thead><tbody>';
          d.relay_conn_details.forEach(function(c){
            html += '<tr><td style="font-family:monospace;font-size:11px">'+c.addr+'</td><td>'+c.dir+'</td><td>'+c.age+'</td><td>'+c.streams+'</td></tr>';
          });
          html += '</tbody></table></div>';
        }

        // ‚îÄ‚îÄ Relay view (relay-side connection info from server) ‚îÄ‚îÄ
        if(d.relay_view&&d.relay_view.length){
          html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">Relay Connections (server side)</span></div>';
          html += '<table class="admin-table"><thead><tr><th>Address</th><th>Dir</th><th>Age</th><th>Streams</th></tr></thead><tbody>';
          d.relay_view.forEach(function(c){
            html += '<tr><td style="font-family:monospace;font-size:11px">'+c.addr+'</td><td>'+(c.dir||'')+'</td><td>'+(c.age||'')+'</td><td>'+(c.streams!==undefined?c.streams:'')+'</td></tr>';
          });
          html += '</tbody></table></div>';
        }

        // ‚îÄ‚îÄ Host addresses ‚îÄ‚îÄ
        html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">Addresses ('+(d.addrs?d.addrs.length:0)+')</span></div>';
        html += '<div style="padding:8px 14px;font-size:12px;font-family:monospace">';
        if(d.addrs&&d.addrs.length){
          d.addrs.forEach(function(a){
            var isCircuit = a.indexOf('p2p-circuit')!==-1;
            html += '<div style="padding:2px 0;color:'+(isCircuit?'#0af':'var(--text)')+'">'+a+(isCircuit?' <span style="background:rgba(0,170,255,0.15);padding:1px 6px;border-radius:4px;font-size:10px">circuit</span>':'')+'</div>';
          });
        } else {
          html += '<div style="color:var(--muted)">No addresses</div>';
        }
        html += '</div></div>';

        // ‚îÄ‚îÄ Listen addresses ‚îÄ‚îÄ
        if(d.listen_addrs&&d.listen_addrs.length){
          html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">Listen Addresses</span></div>';
          html += '<div style="padding:8px 14px;font-size:12px;font-family:monospace">';
          d.listen_addrs.forEach(function(a){ html += '<div style="padding:2px 0">'+a+'</div>'; });
          html += '</div></div>';
        }

        // ‚îÄ‚îÄ Connected peers details ‚îÄ‚îÄ
        if(d.connected_peer_details&&d.connected_peer_details.length){
          html += '<div class="dash-panel glass" style="margin-bottom:16px"><div class="dash-panel-header"><span class="dash-panel-label">Connected Peers ('+d.connected_peer_details.length+' connections)</span></div>';
          html += '<table class="admin-table"><thead><tr><th>Peer</th><th>Address</th><th>Dir</th><th>Age</th><th>Streams</th></tr></thead><tbody>';
          d.connected_peer_details.forEach(function(c){
            var label = c.peer_id.substring(0,16)+'...';
            if(c.is_relay) label += ' <span style="background:rgba(0,170,255,0.15);padding:1px 6px;border-radius:4px;font-size:10px;color:#0af">relay</span>';
            html += '<tr><td style="font-size:11px">'+label+'</td><td style="font-family:monospace;font-size:11px">'+c.addr+'</td><td>'+c.dir+'</td><td>'+c.age+'</td><td>'+c.streams+'</td></tr>';
          });
          html += '</tbody></table></div>';
        }

        // ‚îÄ‚îÄ Relay log ‚îÄ‚îÄ
        html += '<div class="dash-panel glass"><div class="dash-panel-header"><span class="dash-panel-label">Diagnostic Log ('+(d.logs?d.logs.length:0)+' entries)</span></div>';
        html += '<div class="logs-container" style="max-height:400px;overflow-y:auto">';
        if(d.logs&&d.logs.length){
          d.logs.slice().reverse().forEach(function(l){
            html += '<div class="log-entry">'+l+'</div>';
          });
        } else {
          html += '<div class="log-entry empty">No diagnostic log entries yet</div>';
        }
        html += '</div></div>';

        v.innerHTML = html;
      }

      function closeDiag(){
        // Set active section FIRST so updatePeers will render
        if(window._setActiveSection) window._setActiveSection('peers');

        // Clear ALL inline display styles so the CSS class system works again.
        // diagnosePeer() set style.display='none' on every section, which
        // overrides CSS classes and breaks sidebar navigation permanently.
        document.querySelectorAll('.admin-section').forEach(function(s){
          s.style.display = '';
          s.classList.remove('active');
        });
        // Hide diag (it's not in sidebar nav, so it needs explicit inline hide)
        document.querySelector('[data-section="diag"]').style.display = 'none';

        // Activate peers section via class (same mechanism as sidebar nav)
        document.querySelector('[data-section="peers"]').classList.add('active');
        document.querySelectorAll('.admin-nav-item').forEach(function(n){
          n.classList.remove('active');
          if(n.getAttribute('data-section')==='peers') n.classList.add('active');
        });

        // Immediately fetch and render peers ‚Äî don't wait for the 2s poll
        if(window.updatePeers) window.updatePeers();
      }

      function copyDiagResult(){
        var d = window._lastDiag;
        if(!d) return;
        var lines = ['=== Peer Diagnostics ==='];
        lines.push('Peer ID: ' + d.peer_id);
        if(d.name) lines.push('Name: ' + d.name);
        if(d.hostname) lines.push('Hostname: ' + d.hostname);
        if(d.os) lines.push('OS/Arch: ' + d.os + '/' + d.arch);
        if(d.go_version) lines.push('Go: ' + d.go_version);
        if(d.uptime) lines.push('Uptime: ' + d.uptime);
        if(d.started) lines.push('Started: ' + d.started);
        if(d.num_goroutine) lines.push('Goroutines: ' + d.num_goroutine);
        lines.push('Circuit address: ' + (d.has_circuit?'YES':'NO'));
        lines.push('Relay connections: ' + d.relay_conns);
        lines.push('Connected peers: ' + d.connected_peers);
        if(d.presence_ttl) lines.push('Presence TTL: ' + d.presence_ttl);
        lines.push('Site: ' + (d.has_site?'enabled':'disabled'));
        if(d.stream_error) { lines.push(''); lines.push('*** Stream error: ' + d.stream_error); }
        if(d.relay_config) {
          lines.push(''); lines.push('=== Relay Config ===');
          lines.push('Relay Peer ID: ' + d.relay_config.peer_id);
          if(d.relay_config.addrs) d.relay_config.addrs.forEach(function(a){ lines.push('  cfg: ' + a); });
          var ps = d.relay_peerstore_addrs;
          if(ps!==undefined){
            if(ps&&ps.length) { ps.forEach(function(a){ lines.push('  ps:  ' + a); }); }
            else { lines.push('  ps:  EMPTY (expired!)'); }
          }
        }
        if(d.relay_conn_details&&d.relay_conn_details.length) {
          lines.push(''); lines.push('=== Relay Connections (peer side) ===');
          d.relay_conn_details.forEach(function(c){ lines.push('  ' + c.addr + ' | ' + c.dir + ' | age ' + c.age + ' | ' + c.streams + ' streams'); });
        }
        if(d.relay_view&&d.relay_view.length) {
          lines.push(''); lines.push('=== Relay Connections (server side) ===');
          d.relay_view.forEach(function(c){ lines.push('  ' + c.addr + ' | ' + (c.dir||'') + ' | age ' + (c.age||'') + ' | ' + (c.streams!==undefined?c.streams:'') + ' streams'); });
        }
        if(d.addrs) { lines.push(''); lines.push('=== Host Addresses ==='); d.addrs.forEach(function(a){ lines.push('  ' + a); }); }
        if(d.listen_addrs&&d.listen_addrs.length) { lines.push(''); lines.push('=== Listen Addresses ==='); d.listen_addrs.forEach(function(a){ lines.push('  ' + a); }); }
        if(d.connected_peer_details&&d.connected_peer_details.length) {
          lines.push(''); lines.push('=== Connected Peers ===');
          d.connected_peer_details.forEach(function(c){ lines.push('  ' + c.peer_id.substring(0,16) + '... | ' + c.addr + ' | ' + c.dir + ' | age ' + c.age + ' | ' + c.streams + ' streams' + (c.is_relay?' [RELAY]':'')); });
        }
        if(d.logs) { lines.push(''); lines.push('=== Diagnostic Log ==='); d.logs.forEach(function(l){ lines.push('  ' + l); }); }
        navigator.clipboard.writeText(lines.join('\n')).then(function(){
          var btn = document.querySelector('[onclick="copyDiagResult()"]');
          if(btn){ btn.textContent='Copied!'; setTimeout(function(){btn.textContent='Copy';},1500); }
        });
      }

      function copyRelayStatus(){
        var d = window._relayData;
        if(!d) return;
        var lines = ['=== Relay Status ==='];
        if(d.peers&&d.peers.length){
          lines.push('Connected peers: ' + d.peers.length);
          d.peers.forEach(function(p){
            lines.push('  ' + (p.name||'unknown') + ' | ' + p.peer_id + ' | ' + p.addr + ' | ' + p.dir);
          });
        } else {
          lines.push('Connected peers: 0');
        }
        if(d.logs&&d.logs.length){
          lines.push('');
          lines.push('=== Relay Log ===');
          d.logs.forEach(function(l){ lines.push(l); });
        }
        navigator.clipboard.writeText(lines.join('\n')).then(function(){
          var btn = document.querySelector('[onclick="copyRelayStatus()"]');
          if(btn){ btn.textContent = 'Copied!'; setTimeout(function(){ btn.textContent = 'Copy'; }, 1500); }
        });
      }

      // SPA navigation: fetch public pages without credentials so the
      // browser never re-sends cached Basic-Auth headers (avoids
      // password-manager popups on every click).
      (function(){
        document.addEventListener('click', function(e){
          var a = e.target.closest('a');
          if (!a || a.target === '_blank') return;
          var h = a.getAttribute('href');
          if (!h || h.charAt(0) !== '/') return;
          if (h === '/' || h.indexOf('/docs') === 0) {
            e.preventDefault();
            fetch(h, {credentials:'omit'}).then(function(r){
              if (!r.ok) { location.href = h; return; }
              return r.text();
            }).then(function(t){
              if (!t) return;
              history.pushState(null, '', h);
              document.open(); document.write(t); document.close();
            }).catch(function(){ location.href = h; });
          }
        });
        window.addEventListener('popstate', function(){
          var p = location.pathname;
          if (p === '/' || p.indexOf('/docs') === 0) {
            fetch(p, {credentials:'omit'}).then(function(r){ return r.text(); }).then(function(t){
              document.open(); document.write(t); document.close();
            });
          }
        });
      })();

    </script>
  </div>
</body>
</html>
