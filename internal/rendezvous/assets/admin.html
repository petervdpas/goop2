<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{.Title}}</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/assets/style.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="logo">üì°</div>
        <div>
          <h1>{{.Title}}</h1>
          <p class="subtitle"><span class="live-dot"></span>Live dashboard</p>
        </div>
      </div>
      <div class="header-right">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <span class="theme-icon">üåô</span>
        </button>
        <a class="nav-link" href="/docs">Docs</a>
        <a class="nav-link" href="/">Public</a>
      </div>
    </header>

    <div class="admin-layout">
      <!-- Sidebar -->
      <nav class="admin-sidebar glass">
        <div class="admin-sidebar-title">Admin</div>
        <ul class="admin-nav">
          <li class="admin-nav-item active" data-section="overview">Overview</li>
          <li class="admin-nav-item" data-section="peers">Peers <span class="nav-count" id="nav-peer-count">({{.PeerCount}})</span></li>
          {{if .HasRegistrations}}<li class="admin-nav-item" data-section="registrations">Registrations <span class="nav-count" id="nav-reg-count"></span></li>{{end}}
          {{if .HasAccounts}}<li class="admin-nav-item" data-section="accounts">Accounts <span class="nav-count" id="nav-acc-count"></span></li>{{end}}
          {{if .HasCredits}}<li class="admin-nav-item" data-section="prices">Prices</li>{{end}}
          <li class="admin-nav-item" data-section="logs">Logs</li>
        </ul>
      </nav>

      <!-- Main content -->
      <div class="admin-main">

        <!-- ‚îÄ‚îÄ Overview ‚îÄ‚îÄ -->
        <div class="admin-section active" data-section="overview">
          <div class="hero-row">
            <div class="hero-card glass">
              <div class="hero-number" id="count">{{.PeerCount}}</div>
              <div class="hero-label">Connected Peers</div>
            </div>
            <div class="hero-card glass">
              <div class="hero-number" id="clock">{{.Now}}</div>
              <div class="hero-label">Server Time</div>
            </div>
          </div>

          {{if .Services}}
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Services</span>
            </div>
            <div class="svc-list">
              {{range .Services}}
              <div class="svc-row">
                <div class="svc-row-left">
                  <span class="svc-dot {{if not .OK}}svc-dot-err{{else if not .APICompat}}svc-dot-err{{else}}svc-dot-ok{{end}}"></span>
                  <strong>{{.Name}}</strong>
                  {{if .OK}}
                    {{if .DummyMode}}<span class="svc-badge svc-badge-dummy">(dummy)</span>
                    {{else}}<span class="svc-badge svc-badge-ok">(active)</span>{{end}}
                  {{else}}<span class="svc-badge svc-badge-err">not running</span>{{end}}
                  {{if and .OK (not .APICompat)}}<span class="svc-badge svc-badge-err">‚ö† Incompatible API</span>{{end}}
                </div>
                <div class="svc-row-right">
                  {{if .OK}}{{if .Version}}<span>v{{.Version}}</span>{{end}}<span>API v{{.APIVersion}}</span>{{end}}
                  <span>{{.URL}}</span>
                </div>
              </div>
              {{end}}
            </div>
          </div>
          {{end}}

          {{if .Topologies}}
          <div class="dash-panel glass" style="margin-top:.75rem">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Service Dependencies</span>
            </div>
            <div class="svc-list">
              {{range .Topologies}}
              <div class="svc-topo-group">
                <div class="svc-row" style="border-bottom:none;padding-bottom:0">
                  <div class="svc-row-left"><strong>{{.Service}}</strong></div>
                  <div class="svc-row-right"><code>{{.Addr}}</code></div>
                </div>
                {{range .Dependencies}}
                <div class="svc-row svc-dep-row" style="padding-left:2rem;padding-top:0.2rem;padding-bottom:0.2rem">
                  <div class="svc-row-left">
                    <span class="svc-dot {{if .OK}}svc-dot-ok{{else}}svc-dot-err{{end}}"></span>
                    <span>&#8594; {{.Name}}</span>
                    {{if .Error}}<span class="svc-badge svc-badge-err">{{.Error}}</span>{{end}}
                  </div>
                  <div class="svc-row-right">
                    <code>{{if .URL}}{{.URL}}{{else}}(empty){{end}}</code>
                  </div>
                </div>
                {{end}}
              </div>
              {{end}}
            </div>
          </div>
          {{end}}

          {{if .ChainIssues}}
          <div class="dash-panel glass" style="margin-top:.75rem">
            <div class="dash-panel-header">
              <span class="dash-panel-label">&#9888; Chain Issues</span>
            </div>
            <div class="svc-list">
              {{range .ChainIssues}}
              <div class="svc-row" style="color:var(--danger,#e74c3c)">
                <div class="svc-row-left">{{.}}</div>
              </div>
              {{end}}
            </div>
          </div>
          {{end}}
        </div>

        <!-- ‚îÄ‚îÄ Peers ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="peers">
          <div class="search-bar">
            <span class="search-icon">&#x1F50D;</span>
            <input id="q" class="search-input" placeholder="Filter peers..." />
          </div>

          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label"><span class="live-dot"></span> Peers</span>
            </div>
            <div id="peers-container">
              {{if eq (len .Peers) 0}}
              <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <p>No peers connected yet</p>
                <p class="empty-hint">Peers will appear here once they connect</p>
              </div>
              {{else}}
              <div class="peer-grid" id="peer-grid">
                {{range .Peers}}
                <div class="peer-card peer-row" data-status="{{statusClass .Type}}" data-label="{{.Content}}" data-email="{{.Email}}">
                  <div class="peer-header">
                    <span class="status-badge {{statusClass .Type}}">{{.Type}}</span>
                    <span class="peer-time">{{fmtMillis .LastSeen}}</span>
                  </div>
                  <div class="peer-label">{{.Content}}{{if not .Verified}} <span class="badge-unverified">unverified</span>{{end}}</div>
                  {{if .Email}}<div class="peer-email">{{.Email}}</div>{{end}}
                  <div class="peer-id">{{.PeerID}}</div>
                  <div class="peer-stats">
                    <span class="stat-item" title="Sent">‚Üë {{fmtBytes .BytesSent}}</span>
                    <span class="stat-item" title="Received">‚Üì {{fmtBytes .BytesReceived}}</span>
                  </div>
                </div>
                {{end}}
              </div>
              {{end}}
            </div>
          </div>
        </div>

        {{if .HasRegistrations}}
        <!-- ‚îÄ‚îÄ Registrations ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="registrations">
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Registrations</span>
            </div>
            <div id="reg-body">
              <div class="admin-placeholder">Loading...</div>
            </div>
          </div>
        </div>
        {{end}}

        {{if .HasAccounts}}
        <!-- ‚îÄ‚îÄ Credit Accounts ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="accounts">
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Credit Accounts</span>
            </div>
            <div id="acc-body">
              <div class="admin-placeholder">Loading...</div>
            </div>
          </div>
        </div>
        {{end}}

        {{if .HasCredits}}
        <!-- ‚îÄ‚îÄ Prices ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="prices">
          <div class="dash-panel glass">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Template Prices</span>
            </div>
            <div id="prices-body">
              <div class="admin-placeholder">Loading...</div>
            </div>
          </div>
        </div>
        {{end}}

        <!-- ‚îÄ‚îÄ Logs ‚îÄ‚îÄ -->
        <div class="admin-section" data-section="logs">
          <div class="log-tab-bar">
            <button class="btn log-tab active" data-log-tab="rendezvous" onclick="switchLogTab('rendezvous')">Rendezvous</button>
            {{if .Services}}<button class="btn log-tab" data-log-tab="services" onclick="switchLogTab('services')">Services</button>{{end}}
          </div>
          <div class="dash-panel glass" data-log-panel="rendezvous">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Rendezvous Logs</span>
            </div>
            <div class="logs-container" id="logs-container">
              <div class="log-entry empty">Loading...</div>
            </div>
          </div>
          {{if .Services}}
          <div class="dash-panel glass" data-log-panel="services" style="display:none">
            <div class="dash-panel-header">
              <span class="dash-panel-label">Service Logs</span>
            </div>
            <div class="logs-container" id="svc-logs-container">
              <div class="log-entry empty">Loading...</div>
            </div>
          </div>
          {{end}}
        </div>

      </div>
    </div>

    <script>
      function formatBytes(b) {
        if (b < 1024) return b + ' B';
        if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
        if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
        return (b / 1073741824).toFixed(1) + ' GB';
      }

      function fmtDate(v) {
        if (!v) return '';
        if (typeof v === 'number') return new Date(v).toLocaleString();
        var d = new Date(v.indexOf('T') === -1 ? v.replace(' ', 'T') + 'Z' : v);
        return isNaN(d.getTime()) ? v : d.toLocaleString();
      }

      var palette = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63','#00bcd4','#ff5722','#607d8b','#795548','#8bc34a','#673ab7'];
      function hash(s){var h=0;for(var i=0;i<s.length;i++)h=((h<<5)-h+s.charCodeAt(i))|0;return Math.abs(h);}
      function initials(l){l=(l||'').trim();if(!l)return '?';var p=l.split(/\s+/);return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():l.substring(0,Math.min(2,l.length)).toUpperCase();}
      function avatarURI(l,e){var c=palette[hash((l||'')+(e||''))%palette.length];return 'data:image/svg+xml;base64,'+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="'+c+'"/><text x="18" y="18" dy=".35em" text-anchor="middle" font-family="sans-serif" font-size="14" font-weight="600" fill="#fff">'+initials(l)+'</text></svg>');}

      // Theme
      (function(){
        var t=document.getElementById('themeToggle'),i=t.querySelector('.theme-icon'),h=document.documentElement,s=localStorage.getItem('theme')||'dark';
        h.setAttribute('data-theme',s);i.textContent=s==='dark'?'‚òÄÔ∏è':'üåô';
        t.onclick=function(){s=h.getAttribute('data-theme')==='dark'?'light':'dark';h.setAttribute('data-theme',s);localStorage.setItem('theme',s);i.textContent=s==='dark'?'‚òÄÔ∏è':'üåô';};
      })();

      // Live clock
      (function(){
        var el=document.getElementById('clock');
        if(!el)return;
        function tick(){var d=new Date();el.textContent=d.toLocaleTimeString();}
        tick();setInterval(tick,1000);
      })();

      // ‚îÄ‚îÄ Sidebar navigation ‚îÄ‚îÄ
      (function(){
        var items = document.querySelectorAll('.admin-nav-item');
        var sections = document.querySelectorAll('.admin-section');
        var loaded = {};

        items.forEach(function(item){
          item.addEventListener('click', function(){
            var target = item.getAttribute('data-section');
            items.forEach(function(n){ n.classList.remove('active'); });
            item.classList.add('active');
            sections.forEach(function(s){
              s.classList.toggle('active', s.getAttribute('data-section') === target);
            });
            // Lazy-load data sections on first visit
            if (target === 'registrations' && !loaded.reg) { loaded.reg = true; loadRegistrations(); }
            if (target === 'accounts' && !loaded.acc)       { loaded.acc = true; loadAccounts(); }
            if (target === 'prices' && !loaded.prices)      { loaded.prices = true; loadPrices(); }
            if (target === 'logs' && !loaded.logs)          { loaded.logs = true; updateLogs(); if(window.updateServiceLogs) updateServiceLogs(); }
          });
        });
      })();

      // ‚îÄ‚îÄ Live data ‚îÄ‚îÄ
      (function(){
        var R=2000;

        async function updatePeers(){
          if(document.hidden)return;
          var q=document.getElementById('q');if(q&&q===document.activeElement)return;
          try{
            var r=await fetch('/peers.json'),d=await r.json();
            document.getElementById('count').textContent=d.length;
            var nc=document.getElementById('nav-peer-count');if(nc)nc.textContent='('+d.length+')';
            var c=document.getElementById('peers-container');if(!c)return;
            if(!d.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üì≠</div><p>No peers connected yet</p><p class="empty-hint">Peers will appear here once they connect</p></div>';return;}
            c.innerHTML='<div class="peer-grid" id="peer-grid">'+d.map(function(p){
              var sc=p.type==='online'?'on':(p.type==='offline'?'off':'up');
              var ls=p.last_seen?new Date(p.last_seen).toLocaleString():'';
              var av=avatarURI(p.content||'',p.email||'');
              var unverifiedBadge = p.verified ? '' : ' <span class="badge-unverified">unverified</span>';
              return '<div class="peer-card peer-row" data-status="'+sc+'" data-label="'+(p.content||'')+'">'
                +'<div class="peer-header"><img class="peer-avatar" src="'+av+'" width="28" height="28"><span class="status-badge '+sc+'">'+p.type+'</span><span class="peer-time">'+ls+'</span></div>'
                +'<div class="peer-label">'+(p.content||'Unknown')+unverifiedBadge+'</div>'
                +(p.email?'<div class="peer-email">'+p.email+'</div>':'')
                +'<div class="peer-id">'+p.peer_id+'</div>'
                +'<div class="peer-stats"><span class="stat-item">‚Üë '+formatBytes(p.bytes_sent||0)+'</span><span class="stat-item">‚Üì '+formatBytes(p.bytes_received||0)+'</span></div>'
                +'</div>';
            }).join('')+'</div>';
            applyFilter();
          }catch(e){console.error(e);}
        }
        setInterval(updatePeers,R);

        window.updateLogs = async function updateLogs(){
          try{
            var r=await fetch('/logs.json'),l=await r.json(),c=document.getElementById('logs-container');if(!c)return;
            if(!l.length){c.innerHTML='<div class="log-entry empty">No logs yet</div>';return;}
            c.innerHTML=l.reverse().map(function(x){return '<div class="log-entry">'+x+'</div>';}).join('');
          }catch(e){console.error(e);}
        };
        setInterval(updateLogs,R);

        var svcColors = {credits:'#3498db',registration:'#2ecc71',email:'#e67e22',templates:'#9b59b6'};
        window.updateServiceLogs = async function updateServiceLogs(){
          try{
            var r=await fetch('/api/services/logs'),d=await r.json(),c=document.getElementById('svc-logs-container');if(!c)return;
            if(!d||!d.length){c.innerHTML='<div class="log-entry empty">No service logs yet</div>';return;}
            c.innerHTML=d.reverse().map(function(x){
              var col=svcColors[x.service]||'var(--text)';
              return '<div class="log-entry"><span class="log-svc-label" style="color:'+col+'">['+x.service+']</span>'+x.message+'</div>';
            }).join('');
          }catch(e){console.error(e);}
        };
        setInterval(updateServiceLogs,R);

        var q=document.getElementById('q');
        function applyFilter(){
          if(!q)return;
          var v=(q.value||'').toLowerCase().trim(),c=document.getElementById('peers-container');if(!c)return;
          var rows=c.querySelectorAll('.peer-row'),n=0;
          rows.forEach(function(r){var ok=!v||r.textContent.toLowerCase().indexOf(v)!==-1;r.style.display=ok?'':'none';if(ok)n++;});
          document.getElementById('count').textContent=n;
        }
        window.applyFilter=applyFilter;
        if(q) q.addEventListener('input',applyFilter);

        // Inject avatars on initial server-rendered cards
        document.querySelectorAll('.peer-card[data-label]').forEach(function(card){
          var h=card.querySelector('.peer-header');if(!h||h.querySelector('img'))return;
          var img=document.createElement('img');img.src=avatarURI(card.getAttribute('data-label')||'',card.getAttribute('data-email')||'');
          img.width=28;img.height=28;img.className='peer-avatar';
          h.insertBefore(img,h.firstChild);
        });
      })();

      // ‚îÄ‚îÄ Data loaders ‚îÄ‚îÄ
      function loadRegistrations() {
        fetch('/registrations.json').then(function(r){ return r.json(); }).then(function(data){
          var el = document.getElementById('reg-body');
          var nc = document.getElementById('nav-reg-count');
          if (nc) nc.textContent = '(' + data.length + ')';
          if (!data.length) { el.innerHTML = '<div class="admin-placeholder">No registrations yet</div>'; return; }
          var html = '<table class="admin-table"><thead><tr><th>Email</th><th>Status</th><th>Registered</th><th>Verified</th></tr></thead><tbody>';
          data.forEach(function(r){
            var verified = r.verified_at && r.verified_at > 0;
            var badge = verified ? '<span class="badge badge-verified">verified</span>' : '<span class="badge badge-pending">pending</span>';
            html += '<tr><td>' + (r.email||'') + '</td><td>' + badge + '</td><td>' + fmtDate(r.created_at) + '</td><td>' + (verified ? fmtDate(r.verified_at) : '\u2014') + '</td></tr>';
          });
          html += '</tbody></table>';
          el.innerHTML = html;
        }).catch(function(){
          var el = document.getElementById('reg-body');
          if (el) el.innerHTML = '<div class="admin-error">Failed to load registrations</div>';
        });
      }

      function loadAccounts() {
        fetch('/accounts.json').then(function(r){ return r.json(); }).then(function(data){
          var el = document.getElementById('acc-body');
          var nc = document.getElementById('nav-acc-count');
          if (nc) nc.textContent = '(' + data.length + ')';
          if (!data.length) { el.innerHTML = '<div class="admin-placeholder">No credit accounts yet</div>'; return; }
          var html = '<table class="admin-table"><thead><tr><th>Email</th><th>Balance</th><th>Last Activity</th></tr></thead><tbody>';
          data.forEach(function(a){
            html += '<tr><td>' + (a.email||'') + '</td><td>' + a.balance + '</td><td>' + fmtDate(a.updated_at) + '</td></tr>';
          });
          html += '</tbody></table>';
          el.innerHTML = html;
        }).catch(function(){
          var el = document.getElementById('acc-body');
          if (el) el.innerHTML = '<div class="admin-error">Failed to load accounts</div>';
        });
      }

      function loadPrices() {
        var pb = document.getElementById('prices-body');
        Promise.all([
          fetch('/api/templates/prices').then(function(r){ return r.json(); }),
          fetch('/api/templates').then(function(r){ return r.ok ? r.json() : []; })
        ]).then(function(results){
          var prices = results[0] || {};
          var templates = results[1] || [];
          var allDirs = new Set(Object.keys(prices));
          templates.forEach(function(t){ allDirs.add(t.dir); });

          if (allDirs.size === 0) {
            pb.innerHTML = '<div class="admin-placeholder">No templates available</div>';
            return;
          }

          var tplMap = {};
          templates.forEach(function(t){ tplMap[t.dir] = t; });

          var cards = '';
          allDirs.forEach(function(dir){
            var p = prices[dir] || 0;
            var tpl = tplMap[dir] || {};
            var name = tpl.name || dir;
            var icon = tpl.icon || 'üìÑ';
            var badgeClass = p > 0 ? 'price-badge price-badge-paid' : 'price-badge price-badge-free';
            var badgeText = p > 0 ? p + ' credits' : 'Free';

            cards += '<div class="price-card glass">'
              + '<div class="price-card-head">'
              + '<div class="price-card-icon-row">'
              + '<span class="price-card-icon">' + icon + '</span>'
              + '<div>'
              + '<div class="price-card-name">' + name + '</div>'
              + '<code class="price-card-dir">' + dir + '</code>'
              + '</div>'
              + '</div>'
              + '<span class="' + badgeClass + '" data-badge="' + dir + '">' + badgeText + '</span>'
              + '</div>'
              + '<div class="price-card-body">'
              + '<div class="price-input-wrap">'
              + '<input type="number" min="0" value="' + p + '" data-dir="' + dir + '" class="price-input" />'
              + '<span class="price-input-label">credits</span>'
              + '</div>'
              + '</div>'
              + '</div>';
          });

          pb.innerHTML = '<div class="price-grid">' + cards + '</div>'
            + '<div class="price-save-bar">'
            + '<span class="price-save-status" id="save-status"></span>'
            + '<button class="btn primary" id="save-prices">Save Prices</button>'
            + '</div>';

          document.getElementById('save-prices').onclick = savePrices;

          pb.querySelectorAll('.price-input').forEach(function(inp){
            inp.addEventListener('input', function(){
              var dir = inp.getAttribute('data-dir');
              var v = parseInt(inp.value) || 0;
              var badge = pb.querySelector('[data-badge="' + dir + '"]');
              if (!badge) return;
              if (v > 0) {
                badge.className = 'price-badge price-badge-paid';
                badge.textContent = v + ' credits';
              } else {
                badge.className = 'price-badge price-badge-free';
                badge.textContent = 'Free';
              }
            });
          });
        }).catch(function(e){
          pb.innerHTML = '<div class="admin-error">Failed to load prices: ' + e.message + '</div>';
        });
      }

      function savePrices(){
        var pb = document.getElementById('prices-body');
        var btn = document.getElementById('save-prices');
        var status = document.getElementById('save-status');
        var inputs = pb.querySelectorAll('.price-input');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        status.textContent = '';
        status.className = 'price-save-status';

        var promises = [];
        for (var i = 0; i < inputs.length; i++) {
          (function(inp){
            var dir = inp.getAttribute('data-dir');
            var price = parseInt(inp.value) || 0;
            promises.push(
              fetch('/api/templates/prices', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({template: dir, price: price})
              }).then(function(resp){ return resp.ok; })
                .catch(function(){ return false; })
            );
          })(inputs[i]);
        }

        Promise.all(promises).then(function(results){
          btn.disabled = false;
          btn.textContent = 'Save Prices';
          var ok = results.every(function(r){ return r; });
          if (ok) {
            status.textContent = 'Saved';
            status.className = 'price-save-status price-save-ok';
            setTimeout(function(){ status.textContent = ''; status.className = 'price-save-status'; }, 2000);
          } else {
            status.textContent = 'Some prices failed to save';
            status.className = 'price-save-status price-save-err';
          }
        });
      }

      function switchLogTab(tab){
        document.querySelectorAll('.log-tab').forEach(function(b){
          b.classList.toggle('active', b.getAttribute('data-log-tab')===tab);
        });
        document.querySelectorAll('[data-log-panel]').forEach(function(p){
          p.style.display = p.getAttribute('data-log-panel')===tab ? '' : 'none';
        });
        if(tab==='services' && window.updateServiceLogs) updateServiceLogs();
      }

      // SPA navigation: fetch public pages without credentials so the
      // browser never re-sends cached Basic-Auth headers (avoids
      // password-manager popups on every click).
      (function(){
        document.addEventListener('click', function(e){
          var a = e.target.closest('a');
          if (!a || a.target === '_blank') return;
          var h = a.getAttribute('href');
          if (!h || h.charAt(0) !== '/') return;
          if (h === '/' || h.indexOf('/docs') === 0) {
            e.preventDefault();
            fetch(h, {credentials:'omit'}).then(function(r){
              if (!r.ok) { location.href = h; return; }
              return r.text();
            }).then(function(t){
              if (!t) return;
              history.pushState(null, '', h);
              document.open(); document.write(t); document.close();
            }).catch(function(){ location.href = h; });
          }
        });
        window.addEventListener('popstate', function(){
          var p = location.pathname;
          if (p === '/' || p.indexOf('/docs') === 0) {
            fetch(p, {credentials:'omit'}).then(function(r){ return r.text(); }).then(function(t){
              document.open(); document.write(t); document.close();
            });
          }
        });
      })();

    </script>
  </div>
</body>
</html>
