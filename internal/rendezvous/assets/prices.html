<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{.Title}}</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/assets/style.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="logo">üí∞</div>
        <div>
          <h1>{{.Title}}</h1>
          <p class="subtitle">Set credit prices for store templates</p>
        </div>
      </div>
      <div class="header-right">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <span class="theme-icon">üåô</span>
        </button>
        <a class="nav-link" href="/admin">Dashboard</a>
        <a class="nav-link" href="/store">Store</a>
        <a class="nav-link" href="/docs">Docs</a>
        <a class="nav-link" href="/">Public</a>
      </div>
    </header>

    <div id="prices-container">
      <div class="empty-state">
        <div class="empty-icon">‚è≥</div>
        <p>Loading templates...</p>
      </div>
    </div>

    <script>
      // Theme
      (function(){
        var t=document.getElementById('themeToggle'),i=t.querySelector('.theme-icon'),h=document.documentElement,s=localStorage.getItem('theme')||'dark';
        h.setAttribute('data-theme',s);i.textContent=s==='dark'?'‚òÄÔ∏è':'üåô';
        t.onclick=function(){s=h.getAttribute('data-theme')==='dark'?'light':'dark';h.setAttribute('data-theme',s);localStorage.setItem('theme',s);i.textContent=s==='dark'?'‚òÄÔ∏è':'üåô';};
      })();

      // Template Prices management
      (function(){
        var pc = document.getElementById('prices-container');

        async function loadPrices(){
          try {
            var [pricesResp, templatesResp] = await Promise.all([
              fetch('/api/credits/prices'),
              fetch('/api/templates')
            ]);
            var prices = await pricesResp.json();
            var templates = [];
            if (templatesResp.ok) templates = await templatesResp.json();

            if (!prices) prices = {};
            var allDirs = new Set(Object.keys(prices));
            templates.forEach(function(t){ allDirs.add(t.dir); });

            if (allDirs.size === 0) {
              pc.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No templates available</p><p class="empty-hint">Add template directories to your server configuration</p></div>';
              return;
            }

            // Build a lookup for template metadata
            var tplMap = {};
            templates.forEach(function(t){ tplMap[t.dir] = t; });

            var cards = '';
            allDirs.forEach(function(dir){
              var p = prices[dir] || 0;
              var tpl = tplMap[dir] || {};
              var name = tpl.name || dir;
              var icon = tpl.icon || 'üìÑ';
              var badgeClass = p > 0 ? 'price-badge price-badge-paid' : 'price-badge price-badge-free';
              var badgeText = p > 0 ? p + ' credits' : 'Free';

              cards += '<div class="price-card glass">'
                + '<div class="price-card-head">'
                + '<div style="display:flex;align-items:center;gap:10px">'
                + '<span style="font-size:1.6rem">' + icon + '</span>'
                + '<div>'
                + '<div class="price-card-name">' + name + '</div>'
                + '<code class="price-card-dir">' + dir + '</code>'
                + '</div>'
                + '</div>'
                + '<span class="' + badgeClass + '" data-badge="' + dir + '">' + badgeText + '</span>'
                + '</div>'
                + '<div class="price-card-body">'
                + '<div class="price-input-wrap">'
                + '<input type="number" min="0" value="' + p + '" data-dir="' + dir + '" class="price-input" />'
                + '<span class="price-input-label">credits</span>'
                + '</div>'
                + '</div>'
                + '</div>';
            });

            pc.innerHTML = '<div class="price-grid">' + cards + '</div>'
              + '<div class="price-save-bar">'
              + '<span class="price-save-status" id="save-status"></span>'
              + '<button class="btn primary" id="save-prices">Save Prices</button>'
              + '</div>';

            document.getElementById('save-prices').onclick = savePrices;

            // Live-update badges on input change
            pc.querySelectorAll('.price-input').forEach(function(inp){
              inp.addEventListener('input', function(){
                var dir = inp.getAttribute('data-dir');
                var v = parseInt(inp.value) || 0;
                var badge = pc.querySelector('[data-badge="' + dir + '"]');
                if (!badge) return;
                if (v > 0) {
                  badge.className = 'price-badge price-badge-paid';
                  badge.textContent = v + ' credits';
                } else {
                  badge.className = 'price-badge price-badge-free';
                  badge.textContent = 'Free';
                }
              });
            });
          } catch(e) {
            pc.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Failed to load prices</p><p class="empty-hint">' + e.message + '</p></div>';
            console.error(e);
          }
        }

        async function savePrices(){
          var btn = document.getElementById('save-prices');
          var status = document.getElementById('save-status');
          var inputs = pc.querySelectorAll('.price-input');
          btn.disabled = true;
          btn.textContent = 'Saving...';
          status.textContent = '';
          status.className = 'price-save-status';

          var ok = true;
          for (var i = 0; i < inputs.length; i++) {
            var dir = inputs[i].getAttribute('data-dir');
            var price = parseInt(inputs[i].value) || 0;
            try {
              var resp = await fetch('/api/credits/prices', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({template: dir, price: price})
              });
              if (!resp.ok) ok = false;
            } catch(e) {
              ok = false;
              console.error('save price error:', e);
            }
          }

          btn.disabled = false;
          btn.textContent = 'Save Prices';
          if (ok) {
            status.textContent = 'Saved';
            status.className = 'price-save-status price-save-ok';
            setTimeout(function(){ status.textContent = ''; status.className = 'price-save-status'; }, 2000);
          } else {
            status.textContent = 'Some prices failed to save';
            status.className = 'price-save-status price-save-err';
          }
        }

        loadPrices();
      })();

      // SPA navigation for public pages (avoid Basic-Auth popups)
      (function(){
        document.addEventListener('click', function(e){
          var a = e.target.closest('a');
          if (!a || a.target === '_blank') return;
          var h = a.getAttribute('href');
          if (!h || h.charAt(0) !== '/') return;
          if (h === '/' || h.indexOf('/docs') === 0) {
            e.preventDefault();
            fetch(h, {credentials:'omit'}).then(function(r){
              if (!r.ok) { location.href = h; return; }
              return r.text();
            }).then(function(t){
              if (!t) return;
              history.pushState(null, '', h);
              document.open(); document.write(t); document.close();
            }).catch(function(){ location.href = h; });
          }
        });
      })();
    </script>
  </div>
</body>
</html>
