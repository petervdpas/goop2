name: Release goop2

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  GO_VERSION: "1.24.x"
  NODE_VERSION: "20"
  WAILS_VERSION: "v2.11.0"

jobs:
  # ───────────────────────────────────────────────────────────────
  # Windows: build + Inno Setup installer
  # ───────────────────────────────────────────────────────────────
  windows:
    name: Windows Installer
    runs-on: windows-2025
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}" -replace '^v',''
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails CLI
        shell: pwsh
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@${env:WAILS_VERSION}
          wails version

      - name: Build (Windows amd64)
        shell: pwsh
        run: |
          wails doctor
          $ver = "${{ steps.version.outputs.VERSION }}"
          wails build -clean -platform windows/amd64 -ldflags "-X main.appVersion=$ver"

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup -y

      - name: Build installer
        shell: pwsh
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (!(Test-Path $iscc)) { throw "ISCC.exe not found at $iscc" }

          # Verify source files exist
          $issFile = Resolve-Path "build\windows\installer\goop2-installer.iss"
          if (!(Test-Path "build\bin\goop2.exe")) { throw "goop2.exe not found" }
          if (!(Test-Path "build\windows\icon.ico")) { throw "icon.ico not found" }

          Write-Host "CWD:      $(Get-Location)"
          Write-Host "ISS file: $issFile"
          Write-Host "ISCC:     $iscc"

          & $iscc /V9 /DMyAppVersion="${{ steps.version.outputs.VERSION }}" "$issFile"

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "build\windows\installer\output\*.exe" "dist\"
          # Also create a portable zip
          Compress-Archive -Path "build\bin\goop2.exe" -DestinationPath "dist\goop2-${{ steps.version.outputs.VERSION }}-windows-amd64.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Linux portable tarball (Debian bookworm build)
  # ───────────────────────────────────────────────────────────────
  linux_portable:
    name: Linux Portable (tar.gz)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: debian:bookworm
          options: -v ${{ github.workspace }}:/src -w /src -e GITHUB_REF_NAME=${{ github.ref_name }}
          shell: bash
          run: |
            set -euo pipefail

            VERSION="${GITHUB_REF_NAME#v}"
            NODE_VERSION="${NODE_VERSION:-20}"
            WAILS_VERSION="${WAILS_VERSION:-v2.11.0}"
            export NODE_VERSION WAILS_VERSION DEBIAN_FRONTEND=noninteractive

            apt-get update
            apt-get install -y --no-install-recommends \
              bash ca-certificates curl git build-essential pkg-config \
              libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev \
              libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
              libgl1-mesa-dev \
              zip unzip tar gzip
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://deb.nodesource.com/setup_${NODE_VERSION}.x" | bash -
            apt-get update
            apt-get install -y --no-install-recommends nodejs
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://go.dev/dl/go1.24.0.linux-amd64.tar.gz" -o /tmp/go.tgz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH="/usr/local/go/bin:${PATH}"

            go install "github.com/wailsapp/wails/v2/cmd/wails@${WAILS_VERSION}"
            export PATH="$(go env GOPATH)/bin:${PATH}"

            wails doctor
            wails build -clean -platform linux/amd64 -ldflags "-X main.appVersion=${VERSION}"

            # Create portable tarball
            TARDIR="goop2-${VERSION}-linux-amd64"
            mkdir -p "${TARDIR}"
            cp build/bin/goop2 "${TARDIR}/"
            cp build/appicon.png "${TARDIR}/goop2.png"
            [ -f README.md ] && cp README.md "${TARDIR}/"

            mkdir -p /src/dist
            tar czf "/src/dist/goop2-${VERSION}-linux-amd64.tar.gz" "${TARDIR}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-portable
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Linux .deb package (Debian bookworm)
  # ───────────────────────────────────────────────────────────────
  linux_deb:
    name: Linux .deb (Debian/Ubuntu)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: debian:bookworm
          options: -v ${{ github.workspace }}:/src -w /src -e GITHUB_REF_NAME=${{ github.ref_name }}
          shell: bash
          run: |
            set -euo pipefail

            VERSION="${GITHUB_REF_NAME#v}"
            NODE_VERSION="${NODE_VERSION:-20}"
            WAILS_VERSION="${WAILS_VERSION:-v2.11.0}"
            export NODE_VERSION WAILS_VERSION DEBIAN_FRONTEND=noninteractive

            apt-get update
            apt-get install -y --no-install-recommends \
              bash ca-certificates curl git build-essential pkg-config \
              libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev \
              libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
              libgl1-mesa-dev \
              zip unzip fakeroot dpkg dpkg-dev
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://deb.nodesource.com/setup_${NODE_VERSION}.x" | bash -
            apt-get update
            apt-get install -y --no-install-recommends nodejs
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://go.dev/dl/go1.24.0.linux-amd64.tar.gz" -o /tmp/go.tgz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH="/usr/local/go/bin:${PATH}"

            go install "github.com/wailsapp/wails/v2/cmd/wails@${WAILS_VERSION}"
            export PATH="$(go env GOPATH)/bin:${PATH}"

            wails doctor
            wails build -clean -platform linux/amd64 -ldflags "-X main.appVersion=${VERSION}"

            # Assemble .deb
            PKG="goop2_${VERSION}_amd64"
            mkdir -p "${PKG}/DEBIAN"
            mkdir -p "${PKG}/opt/goop2"
            mkdir -p "${PKG}/usr/bin"
            mkdir -p "${PKG}/usr/share/applications"
            mkdir -p "${PKG}/usr/share/icons/hicolor/256x256/apps"

            sed "s/^Version:.*/Version: ${VERSION}/" build/linux/deb/control > "${PKG}/DEBIAN/control"
            cp build/linux/deb/postinst "${PKG}/DEBIAN/postinst"
            chmod 755 "${PKG}/DEBIAN/postinst"

            cp build/bin/goop2 "${PKG}/opt/goop2/goop2"
            chmod 755 "${PKG}/opt/goop2/goop2"
            cp build/linux/goop2-wrapper.sh "${PKG}/usr/bin/goop2"
            chmod 755 "${PKG}/usr/bin/goop2"
            cp build/linux/goop2.desktop "${PKG}/usr/share/applications/"
            cp build/appicon.png "${PKG}/usr/share/icons/hicolor/256x256/apps/goop2.png"

            mkdir -p /src/dist
            fakeroot dpkg-deb --build "${PKG}" "/src/dist/${PKG}.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-deb
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Linux ARM64 portable tarball (Raspberry Pi)
  # ───────────────────────────────────────────────────────────────
  # TODO: re-enable when ARM runners are available
  linux_portable_arm64:
    if: false
    name: Linux ARM64 Portable (tar.gz)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: debian:bookworm
          options: -v ${{ github.workspace }}:/src -w /src -e GITHUB_REF_NAME=${{ github.ref_name }}
          shell: bash
          run: |
            set -euo pipefail

            VERSION="${GITHUB_REF_NAME#v}"
            NODE_VERSION="${NODE_VERSION:-20}"
            WAILS_VERSION="${WAILS_VERSION:-v2.11.0}"
            export NODE_VERSION WAILS_VERSION DEBIAN_FRONTEND=noninteractive

            apt-get update
            apt-get install -y --no-install-recommends \
              bash ca-certificates curl git build-essential pkg-config \
              libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev \
              libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
              libgl1-mesa-dev \
              zip unzip tar gzip
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://deb.nodesource.com/setup_${NODE_VERSION}.x" | bash -
            apt-get update
            apt-get install -y --no-install-recommends nodejs
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://go.dev/dl/go1.24.0.linux-arm64.tar.gz" -o /tmp/go.tgz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH="/usr/local/go/bin:${PATH}"

            go install "github.com/wailsapp/wails/v2/cmd/wails@${WAILS_VERSION}"
            export PATH="$(go env GOPATH)/bin:${PATH}"

            wails doctor
            wails build -clean -platform linux/arm64 -tags webkit2_41 -ldflags "-X main.appVersion=${VERSION}"

            # Create portable tarball
            TARDIR="goop2-${VERSION}-linux-arm64"
            mkdir -p "${TARDIR}"
            cp build/bin/goop2 "${TARDIR}/"
            cp build/appicon.png "${TARDIR}/goop2.png"
            [ -f README.md ] && cp README.md "${TARDIR}/"

            mkdir -p /src/dist
            tar czf "/src/dist/goop2-${VERSION}-linux-arm64.tar.gz" "${TARDIR}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-portable-arm64
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Linux ARM64 .deb package (Raspberry Pi)
  # ───────────────────────────────────────────────────────────────
  # TODO: re-enable when ARM runners are available
  linux_deb_arm64:
    if: false
    name: Linux ARM64 .deb (Raspberry Pi)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: debian:bookworm
          options: -v ${{ github.workspace }}:/src -w /src -e GITHUB_REF_NAME=${{ github.ref_name }}
          shell: bash
          run: |
            set -euo pipefail

            VERSION="${GITHUB_REF_NAME#v}"
            NODE_VERSION="${NODE_VERSION:-20}"
            WAILS_VERSION="${WAILS_VERSION:-v2.11.0}"
            export NODE_VERSION WAILS_VERSION DEBIAN_FRONTEND=noninteractive

            apt-get update
            apt-get install -y --no-install-recommends \
              bash ca-certificates curl git build-essential pkg-config \
              libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev \
              libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
              libgl1-mesa-dev \
              zip unzip fakeroot dpkg dpkg-dev
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://deb.nodesource.com/setup_${NODE_VERSION}.x" | bash -
            apt-get update
            apt-get install -y --no-install-recommends nodejs
            rm -rf /var/lib/apt/lists/*

            curl -fsSL "https://go.dev/dl/go1.24.0.linux-arm64.tar.gz" -o /tmp/go.tgz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH="/usr/local/go/bin:${PATH}"

            go install "github.com/wailsapp/wails/v2/cmd/wails@${WAILS_VERSION}"
            export PATH="$(go env GOPATH)/bin:${PATH}"

            wails doctor
            wails build -clean -platform linux/arm64 -tags webkit2_41 -ldflags "-X main.appVersion=${VERSION}"

            # Assemble .deb
            PKG="goop2_${VERSION}_arm64"
            mkdir -p "${PKG}/DEBIAN"
            mkdir -p "${PKG}/opt/goop2"
            mkdir -p "${PKG}/usr/bin"
            mkdir -p "${PKG}/usr/share/applications"
            mkdir -p "${PKG}/usr/share/icons/hicolor/256x256/apps"

            sed -e "s/^Version:.*/Version: ${VERSION}/" \
                -e "s/^Architecture:.*/Architecture: arm64/" \
                -e "s/libwebkit2gtk-4.0-37/libwebkit2gtk-4.1-0/" \
                build/linux/deb/control > "${PKG}/DEBIAN/control"
            cp build/linux/deb/postinst "${PKG}/DEBIAN/postinst"
            chmod 755 "${PKG}/DEBIAN/postinst"

            cp build/bin/goop2 "${PKG}/opt/goop2/goop2"
            chmod 755 "${PKG}/opt/goop2/goop2"
            cp build/linux/goop2-wrapper.sh "${PKG}/usr/bin/goop2"
            chmod 755 "${PKG}/usr/bin/goop2"
            cp build/linux/goop2.desktop "${PKG}/usr/share/applications/"
            cp build/appicon.png "${PKG}/usr/share/icons/hicolor/256x256/apps/goop2.png"

            mkdir -p /src/dist
            fakeroot dpkg-deb --build "${PKG}" "/src/dist/${PKG}.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-deb-arm64
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Fedora 41 RPM
  # ───────────────────────────────────────────────────────────────
  rpm_fedora41:
    name: Fedora 41 RPM
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: fedora:41
          options: -v ${{ github.workspace }}:/src -w /src -e GITHUB_REF_NAME=${{ github.ref_name }}
          shell: bash
          run: |
            set -euo pipefail

            VERSION="${GITHUB_REF_NAME#v}"
            NODE_VERSION="${NODE_VERSION:-20}"
            WAILS_VERSION="${WAILS_VERSION:-v2.11.0}"
            export NODE_VERSION WAILS_VERSION

            dnf -y update
            dnf -y install \
              bash ca-certificates curl git \
              gcc gcc-c++ make pkgconf-pkg-config \
              gtk3-devel webkit2gtk3-devel libayatana-appindicator-gtk3-devel \
              libX11-devel libXrandr-devel libXinerama-devel libXcursor-devel libXi-devel \
              mesa-libGL-devel \
              zip unzip tar gzip rpm-build

            curl -fsSL "https://rpm.nodesource.com/setup_${NODE_VERSION}.x" | bash -
            dnf -y install nodejs

            curl -fsSL "https://go.dev/dl/go1.24.0.linux-amd64.tar.gz" -o /tmp/go.tgz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH="/usr/local/go/bin:${PATH}"

            go install "github.com/wailsapp/wails/v2/cmd/wails@${WAILS_VERSION}"
            export PATH="$(go env GOPATH)/bin:${PATH}"

            wails doctor
            wails build -clean -platform linux/amd64 -ldflags "-X main.appVersion=${VERSION}"

            # Set up rpmbuild
            RPMTOP="$HOME/rpmbuild"
            mkdir -p "$RPMTOP"/{SPECS,SOURCES,BUILD,RPMS,SRPMS}

            sed "s/^Version:.*/Version:        ${VERSION}/" build/linux/rpm/goop2.spec > "$RPMTOP/SPECS/goop2.spec"

            cp build/bin/goop2 "$RPMTOP/SOURCES/"
            cp build/linux/goop2-wrapper.sh "$RPMTOP/SOURCES/"
            cp build/linux/goop2.desktop "$RPMTOP/SOURCES/"
            cp build/appicon.png "$RPMTOP/SOURCES/goop2.png"

            rpmbuild -bb "$RPMTOP/SPECS/goop2.spec" --define "_topdir ${RPMTOP}"

            mkdir -p /src/dist
            find "$RPMTOP/RPMS" -name "*.rpm" -exec cp {} /src/dist/ \;

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-rpm-fedora41
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Fedora 42 RPM
  # ───────────────────────────────────────────────────────────────
  rpm_fedora42:
    name: Fedora 42 RPM
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: fedora:42
          options: -v ${{ github.workspace }}:/src -w /src -e GITHUB_REF_NAME=${{ github.ref_name }}
          shell: bash
          run: |
            set -euo pipefail

            VERSION="${GITHUB_REF_NAME#v}"
            NODE_VERSION="${NODE_VERSION:-20}"
            WAILS_VERSION="${WAILS_VERSION:-v2.11.0}"
            export NODE_VERSION WAILS_VERSION

            dnf -y update
            dnf -y install \
              bash ca-certificates curl git \
              gcc gcc-c++ make pkgconf-pkg-config \
              gtk3-devel webkit2gtk3-devel libayatana-appindicator-gtk3-devel \
              libX11-devel libXrandr-devel libXinerama-devel libXcursor-devel libXi-devel \
              mesa-libGL-devel \
              zip unzip tar gzip rpm-build

            curl -fsSL "https://rpm.nodesource.com/setup_${NODE_VERSION}.x" | bash -
            dnf -y install nodejs

            curl -fsSL "https://go.dev/dl/go1.24.0.linux-amd64.tar.gz" -o /tmp/go.tgz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH="/usr/local/go/bin:${PATH}"

            go install "github.com/wailsapp/wails/v2/cmd/wails@${WAILS_VERSION}"
            export PATH="$(go env GOPATH)/bin:${PATH}"

            wails doctor
            wails build -clean -platform linux/amd64 -ldflags "-X main.appVersion=${VERSION}"

            # Set up rpmbuild
            RPMTOP="$HOME/rpmbuild"
            mkdir -p "$RPMTOP"/{SPECS,SOURCES,BUILD,RPMS,SRPMS}

            sed "s/^Version:.*/Version:        ${VERSION}/" build/linux/rpm/goop2.spec > "$RPMTOP/SPECS/goop2.spec"

            cp build/bin/goop2 "$RPMTOP/SOURCES/"
            cp build/linux/goop2-wrapper.sh "$RPMTOP/SOURCES/"
            cp build/linux/goop2.desktop "$RPMTOP/SOURCES/"
            cp build/appicon.png "$RPMTOP/SOURCES/goop2.png"

            rpmbuild -bb "$RPMTOP/SPECS/goop2.spec" --define "_topdir ${RPMTOP}"

            mkdir -p /src/dist
            find "$RPMTOP/RPMS" -name "*.rpm" -exec cp {} /src/dist/ \;

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-rpm-fedora42
          path: dist/*

  # ───────────────────────────────────────────────────────────────
  # Publish GitHub Release
  # ───────────────────────────────────────────────────────────────
  release:
    name: Publish GitHub Release
    needs: [windows, linux_portable, linux_deb, rpm_fedora41, rpm_fedora42]
    runs-on: ubuntu-24.04
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Flatten artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          find artifacts -maxdepth 8 -type f -exec cp -v "{}" dist/ \;
          echo "--- Release assets ---"
          ls -la dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Goop2 ${{ github.ref_name }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: dist/*
